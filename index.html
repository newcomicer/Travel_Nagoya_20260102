<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>åŒ—é™¸åèŠ±ä¹‹é‡Œä¹‹æ—… 2026</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'nook-bg': '#F7F4EB',
                    'nook-green': '#88AB8E',
                    'nook-dark': '#6B5B45',
                    'nook-card': '#FFFFFF',
                    'nook-accent': '#E76F51',
                    'weather-sun': '#FFB703',
                    'weather-rain': '#8ECAE6',
                    'weather-cloud': '#A2D2FF',
                },
                boxShadow: {
                    'soft': '4px 4px 0px #E0E5D5',
                    'soft-hover': '2px 2px 0px #E0E5D5',
                },
                fontFamily: {
                    'rounded': ['"M PLUS Rounded 1c"', 'sans-serif'],
                }
            }
        }
    }
</script>

<style>
    body {
        font-family: 'M PLUS Rounded 1c', sans-serif;
        background-color: #F7F4EB;
        background-image: radial-gradient(#E0E5D5 2px, transparent 2px);
        background-size: 20px 20px;
        color: #6B5B45;
        -webkit-tap-highlight-color: transparent;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .btn-press:active { transform: scale(0.95); box-shadow: 2px 2px 0px #E0E5D5 !important; transform: translate(2px, 2px); }
    .btn-disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

    .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
    .tab-content.active { display: block; }

    .edit-input { width: 100%; border-bottom: 1px dashed #88AB8E; background: transparent; outline: none; padding: 2px 0; color: #6B5B45; }
    .edit-input:focus { border-bottom: 2px solid #88AB8E; }
    
    .login-overlay { position: fixed; inset: 0; background: #F7F4EB; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }

    /* Weather Animations */
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
    .weather-icon-anim { animation: float 3s ease-in-out infinite; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .nav-item.active i { color: #88AB8E; transform: scale(1.1); }
    .nav-item.active span { color: #88AB8E; font-weight: bold; }
    
    .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #88AB8E; border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body class="pb-24">

<!-- Login Screen -->
<div id="login-screen" class="login-overlay">
    <div class="bg-white p-8 rounded-3xl shadow-soft w-full max-w-sm border border-[#E0E5D5]">
        <h1 class="text-2xl font-bold text-nook-green text-center mb-6">
            <i class="fa-solid fa-plane-departure mr-2"></i>æ—…ç¨‹ç™»å…¥
        </h1>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-gray-500 mb-1">å¸³è™Ÿ (Username)</label>
                <input type="text" id="login-user" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-nook-green transition">
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-500 mb-1">å¯†ç¢¼ (Password)</label>
                <input type="password" id="login-pass" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-nook-green transition">
            </div>
            <button onclick="performLogin()" id="login-btn" class="w-full bg-nook-dark text-white font-bold py-3 rounded-xl shadow-soft btn-press mt-4">
                é€²å…¥ App
            </button>
            <p id="login-msg" class="text-center text-red-500 text-sm mt-2 h-5"></p>
        </div>
    </div>
</div>

<header class="sticky top-0 z-40 bg-[#F7F4EB]/95 backdrop-blur-sm px-4 py-3 border-b border-[#E0E5D5] shadow-sm">
    <div class="flex justify-between items-center">
        <h1 class="text-lg font-bold text-nook-green tracking-wide truncate flex items-center">
            <i class="fa-solid fa-plane-departure mr-2"></i>
            <span class="truncate">åŒ—é™¸ä¹‹æ—…</span>
            <span id="header-user-badge" class="ml-2 text-[10px] bg-nook-green text-white px-2 py-0.5 rounded-full opacity-0"></span>
        </h1>
        <div class="flex items-center gap-2">
            <button onclick="loadFromCloud()" id="load-btn" class="bg-white px-2 py-1.5 rounded-full shadow-soft border border-[#E0E5D5] text-purple-500 font-bold active:scale-95 transition cursor-pointer flex items-center justify-center min-w-[35px]" title="è®€å–é›²ç«¯å­˜æª”">
                <i class="fa-solid fa-download text-sm"></i>
            </button>
            <button onclick="syncToCloud()" id="sync-btn" class="bg-white px-2 py-1.5 rounded-full shadow-soft border border-[#E0E5D5] text-blue-500 font-bold active:scale-95 transition cursor-pointer flex items-center justify-center min-w-[35px]" title="ä¸Šå‚³è‡³é›²ç«¯">
                <i class="fa-solid fa-cloud-arrow-up text-sm"></i>
            </button>
            <button onclick="toggleEditMode()" id="edit-btn" class="bg-white px-3 py-1.5 rounded-full shadow-soft border border-[#E0E5D5] text-gray-600 font-bold active:scale-95 transition cursor-pointer text-xs flex items-center min-w-[60px] justify-center">
                <i class="fa-solid fa-pen mr-1"></i>ç·¨è¼¯
            </button>
        </div>
    </div>
</header>

<main id="app" class="px-4 py-4 max-w-md mx-auto">
    
    <section id="view-plan" class="tab-content active">
        <div class="flex justify-between items-center mb-3 px-1">
            <div id="clock" class="text-xs font-mono text-nook-dark font-bold ml-auto">00:00</div>
        </div>

        <div id="header-cards"></div>
        <div class="flex overflow-x-auto no-scrollbar gap-2 mb-4 pb-1 mt-6" id="day-tabs"></div>
        <div id="itinerary-container" class="min-h-[300px]"></div>
        
        <div id="add-activity-btn" class="hidden mt-4 text-center">
            <button onclick="addNewActivity()" class="bg-nook-green text-white px-4 py-2 rounded-xl shadow-soft btn-press text-sm font-bold w-full">
                <i class="fa-solid fa-plus mr-2"></i>æ–°å¢è¡Œç¨‹é …ç›®
            </button>
        </div>
    </section>

    <!-- è¨˜äº‹æœ¬å€å¡Š -->
    <section id="view-notes" class="tab-content">
        <div class="bg-white rounded-2xl p-5 border border-[#E0E5D5] shadow-soft mb-4">
             <div class="flex overflow-x-auto no-scrollbar gap-2 mb-4 pb-1" id="note-day-tabs"></div>
             
             <div class="mb-4">
                 <textarea id="note-input" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm outline-none focus:border-nook-green resize-none" rows="3" placeholder="ç´€éŒ„ä»Šå¤©çš„è¶£äº‹..."></textarea>
                 <button onclick="addNote()" class="bg-nook-dark text-white w-full py-2 rounded-xl mt-2 font-bold shadow-sm btn-press text-sm">
                     <i class="fa-solid fa-paper-plane mr-2"></i>ç™¼å¸ƒç­†è¨˜
                 </button>
             </div>

             <h3 class="font-bold text-nook-green mb-3 flex items-center"><i class="fa-solid fa-comments mr-2"></i>è¨˜äº‹ç•™è¨€æ¿</h3>
             <div id="note-list" class="space-y-3 min-h-[200px]"></div>
        </div>
    </section>

    <!-- Wallet Section -->
    <section id="view-wallet" class="tab-content">
        <!-- Top Tabs -->
        <div class="bg-white rounded-full p-1 flex shadow-soft border border-[#E0E5D5] mb-6">
            <button onclick="setWalletMode('input')" id="tab-wallet-input" class="flex-1 py-2 rounded-full text-sm font-bold transition-all bg-nook-green text-white"><i class="fa-solid fa-pen mr-1"></i>è¨˜å¸³</button>
            <button onclick="setWalletMode('list')" id="tab-wallet-list" class="flex-1 py-2 rounded-full text-sm font-bold text-gray-500 hover:text-gray-700 transition-all"><i class="fa-solid fa-list-ul mr-1"></i>æ˜ç´°</button>
        </div>
        
        <!-- Input Mode -->
        <div id="wallet-input-view">
             <!-- Rate Setting (Small) -->
             <div class="flex justify-end items-center mb-2 px-1">
                 <label class="text-[10px] text-gray-400 mr-1">ç›®å‰åŒ¯ç‡</label>
                 <input type="number" id="exchange-rate" value="0.22" step="0.001" class="w-12 text-right text-gray-500 rounded border border-gray-200 px-1 py-0.5 text-[10px] bg-white" onchange="saveRate()">
             </div>

             <div class="bg-white rounded-3xl p-5 border border-[#E0E5D5] shadow-soft mb-6">
                <div class="flex items-center gap-2 mb-4 text-nook-accent font-bold">
                    <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center"><i class="fa-solid fa-sack-dollar"></i></div>
                    <h3>è¨˜å¸³è¼¸å…¥</h3>
                </div>

                <!-- Date -->
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 mb-1">æ—¥æœŸ</label>
                    <input type="date" id="expense-date" class="w-full bg-[#F7F4EB] rounded-xl px-4 py-3 text-sm font-bold text-gray-700 outline-none border border-transparent focus:border-nook-green">
                </div>

                <!-- Currency -->
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 mb-1">å¹£åˆ¥ (é è¨­ JPY)</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="selectCurrency('JPY')" id="curr-btn-jpy" class="flex-1 py-2 rounded-xl text-sm font-bold border border-nook-green bg-nook-green text-white transition">JPY</button>
                        <button type="button" onclick="selectCurrency('TWD')" id="curr-btn-twd" class="flex-1 py-2 rounded-xl text-sm font-bold border border-gray-200 text-gray-500 bg-white hover:bg-gray-50 transition">TWD</button>
                    </div>
                </div>

                <!-- Amount -->
                <div class="flex gap-3 mb-4">
                    <div class="flex-1">
                         <label class="block text-xs font-bold text-nook-accent mb-1">* é‡‘é¡</label>
                         <input type="number" id="expense-amount" placeholder="0" class="w-full bg-[#F7F4EB] rounded-xl px-4 py-3 text-xl font-bold text-gray-700 outline-none border border-transparent focus:border-nook-green" oninput="calculateEquivalent()">
                    </div>
                    <div class="w-1/3">
                         <label class="block text-xs font-bold text-gray-400 mb-1">ç´„åˆå°å¹£</label>
                         <div id="expense-equiv" class="w-full bg-white border border-gray-200 rounded-xl px-3 py-3 text-xl font-bold text-gray-400 text-right">0</div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 mb-1">æ”¯ä»˜æ–¹å¼</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="selectMethod('ç¾é‡‘')" id="method-btn-cash" class="flex-1 py-2 rounded-xl text-xs font-bold border border-nook-green text-nook-green bg-green-50 transition">ç¾é‡‘</button>
                        <button type="button" onclick="selectMethod('ä¿¡ç”¨å¡')" id="method-btn-card" class="flex-1 py-2 rounded-xl text-xs font-bold border border-gray-200 text-gray-500 bg-white hover:bg-gray-50 transition">ä¿¡ç”¨å¡</button>
                        <button type="button" onclick="selectMethod('è¡Œå‹•æ”¯ä»˜')" id="method-btn-mobile" class="flex-1 py-2 rounded-xl text-xs font-bold border border-gray-200 text-gray-500 bg-white hover:bg-gray-50 transition">è¡Œå‹•æ”¯ä»˜</button>
                    </div>
                </div>

                <!-- Location -->
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 mb-1">åœ°é» (é¸å¡«)</label>
                    <div class="relative">
                        <i class="fa-solid fa-location-dot absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="text" id="expense-location" placeholder="ä¾‹å¦‚: GS25" class="w-full bg-[#F7F4EB] rounded-xl pl-10 pr-4 py-3 text-sm font-bold text-gray-700 outline-none border border-transparent focus:border-nook-green">
                    </div>
                </div>

                <!-- Item & Photo -->
                <div class="mb-6 flex gap-3 items-end">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-nook-accent mb-1">* æ¶ˆè²»é …ç›®</label>
                        <input type="text" id="expense-item" placeholder="ä¾‹å¦‚: é£²æ–™" class="w-full bg-[#F7F4EB] rounded-xl px-4 py-3 text-lg font-bold text-gray-700 outline-none border border-transparent focus:border-nook-green">
                    </div>
                    <label class="w-14 h-14 flex items-center justify-center bg-green-50 rounded-xl border border-nook-green/30 cursor-pointer text-nook-green hover:bg-green-100 transition relative">
                        <i class="fa-solid fa-camera text-xl"></i>
                        <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handleWalletPhoto(this)">
                        <div id="photo-check" class="hidden absolute -top-1 -right-1 bg-nook-green text-white w-4 h-4 rounded-full text-[10px] flex items-center justify-center"><i class="fa-solid fa-check"></i></div>
                    </label>
                </div>

                <!-- Member Selection -->
                <div class="mb-2">
                     <label class="block text-xs font-bold text-gray-400 mb-2">è¨˜å¸³æˆå“¡ (èª°ä»˜çš„/èª°çš„å¸³)</label>
                     <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2" id="wallet-users-container"></div>
                </div>
             </div>

             <div class="h-20"></div> <!-- Spacer -->
             
             <!-- Centered Fixed Button Container -->
             <div class="fixed bottom-[80px] left-0 right-0 mx-auto w-full max-w-md px-4 z-30 flex justify-center">
                 <button onclick="addExpense()" id="save-expense-btn" class="w-full bg-nook-green text-white rounded-2xl py-3 font-bold shadow-soft btn-press text-lg">
                     ç¢ºèªè¨˜å¸³
                 </button>
             </div>
        </div>

        <!-- List Mode -->
        <div id="wallet-list-view" class="hidden">
            <!-- Summary Card -->
            <div class="bg-[#F2D06B] rounded-3xl p-6 shadow-soft mb-6 text-[#6B5B45]">
                <div class="flex justify-between items-start mb-2">
                    <div class="font-bold opacity-80 text-sm"><span id="summary-user-name">å…¨é«”</span> çš„æ”¯å‡º (TWD)</div>
                </div>
                <div class="text-4xl font-bold font-mono mb-4">NT$ <span id="summary-total-twd">0</span></div>
                <div class="bg-white/30 rounded-xl p-3 flex justify-between items-center backdrop-blur-sm">
                    <div>
                        <div class="text-[10px] opacity-70 font-bold">æ—¥å¹£æ”¯å‡º</div>
                        <div class="font-mono font-bold">Â¥ <span id="summary-total-jpy">0</span></div>
                    </div>
                    <div class="text-right border-l border-[#6B5B45]/20 pl-4">
                        <div class="text-[10px] opacity-70 font-bold">åŒ¯ç‡</div>
                        <div class="font-mono font-bold">1 : <span id="summary-rate">0.22</span></div>
                    </div>
                </div>
            </div>

            <!-- List Header -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-gray-600 border-l-4 border-nook-green pl-3 text-lg">å¸³å‹™æ˜ç´°</h3>
                <div class="flex bg-white rounded-lg p-1 border border-gray-200 shadow-sm overflow-x-auto no-scrollbar max-w-[60%]" id="filter-users-container"></div>
            </div>

            <!-- List Items -->
            <div id="expense-list" class="space-y-3 pb-20"></div>
        </div>
    </section>

    <!-- Preparation Section (Updated Layout with Photo & Link) -->
    <section id="view-lists" class="tab-content">
         <!-- Category Tabs -->
         <div class="bg-white rounded-full p-2 flex shadow-soft border border-[#E0E5D5] mb-4 gap-1 overflow-x-auto no-scrollbar" id="prep-tabs-container">
             <button onclick="setPrepCategory('todo')" id="tab-prep-todo" class="flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-bold transition-all bg-nook-green text-white"><i class="fa-solid fa-check-square mr-1"></i>å¾…è¾¦</button>
             <button onclick="setPrepCategory('luggage')" id="tab-prep-luggage" class="flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-bold transition-all text-gray-500 hover:bg-gray-100"><i class="fa-solid fa-suitcase mr-1"></i>è¡Œæ</button>
             <button onclick="setPrepCategory('wishlist')" id="tab-prep-wishlist" class="flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-bold transition-all text-gray-500 hover:bg-gray-100"><i class="fa-solid fa-heart mr-1"></i>æƒ³å»</button>
             <button onclick="setPrepCategory('shopping')" id="tab-prep-shopping" class="flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-bold transition-all text-gray-500 hover:bg-gray-100"><i class="fa-solid fa-cart-shopping mr-1"></i>æ¡è³¼</button>
         </div>

         <!-- Filter Chips -->
         <div class="flex overflow-x-auto no-scrollbar gap-2 mb-4 px-1" id="prep-filter-container">
             <!-- Populated dynamically -->
         </div>

         <!-- Input Area (with Photo & Link) -->
         <div class="bg-white rounded-3xl p-4 border border-[#E0E5D5] shadow-soft mb-4">
             <div class="flex gap-2 mb-2 items-start">
                 <label class="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-gray-100 rounded-xl cursor-pointer text-gray-400 hover:bg-gray-200 transition relative mt-1">
                    <i class="fa-solid fa-camera"></i>
                    <input type="file" id="prep-photo" accept="image/*" class="hidden" onchange="handlePrepPhoto(this)">
                    <div id="prep-photo-check" class="hidden absolute -top-1 -right-1 bg-nook-green text-white w-3 h-3 rounded-full text-[8px] flex items-center justify-center"><i class="fa-solid fa-check"></i></div>
                 </label>
                 
                 <div class="flex-1 flex flex-col gap-2">
                     <input type="text" id="prep-input" placeholder="æ–°å¢äº‹é …..." class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:bg-white border border-transparent focus:border-nook-green transition">
                     <input type="text" id="prep-link" placeholder="ğŸ”— Google Maps é€£çµ (é¸å¡«)" class="hidden w-full bg-gray-50 rounded-xl px-4 py-2 text-xs outline-none focus:bg-white border border-transparent focus:border-blue-400 transition text-blue-600">
                 </div>

                 <button onclick="addPrepItem()" class="bg-nook-green text-white w-12 h-10 rounded-xl shadow-sm btn-press flex items-center justify-center font-bold text-xl mt-1"><i class="fa-solid fa-plus"></i></button>
             </div>
             <!-- Quick User Tagging for New Item -->
             <div class="flex gap-2 overflow-x-auto no-scrollbar" id="prep-new-user-tags">
                 <!-- Populated dynamically -->
             </div>
         </div>

         <!-- List Items -->
         <div id="prep-list-container" class="space-y-3 pb-20"></div>
    </section>

    <section id="view-info" class="tab-content">
        <!-- Weather Panel -->
        <div class="mb-6">
            <h3 class="font-bold text-nook-green mb-3 flex items-center"><i class="fa-solid fa-temperature-three-quarters mr-2"></i>ç•¶åœ°å¤©æ°£ (å³æ™‚)</h3>
            <div id="weather-list" class="space-y-2">
                <div class="text-center text-gray-400 text-xs py-2"><span class="spinner"></span>è¼‰å…¥ä¸­...</div>
            </div>
        </div>

         <div class="grid grid-cols-2 gap-4 mb-6">
            <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-blue-50 p-4 rounded-2xl border border-blue-100 shadow-sm flex flex-col items-center justify-center text-center btn-press">
                <i class="fa-solid fa-cloud-sun text-3xl text-blue-400 mb-2"></i><span class="font-bold text-gray-700">è©³ç´°é å ±</span>
            </a>
            <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="bg-purple-50 p-4 rounded-2xl border border-purple-100 shadow-sm flex flex-col items-center justify-center text-center btn-press">
                <i class="fa-solid fa-qrcode text-3xl text-purple-500 mb-2"></i><span class="font-bold text-gray-700">Visit Japan</span>
            </a>
        </div>
    </section>

</main>

<div id="image-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/90 backdrop-blur-sm p-4" onclick="closeImageModal()">
    <button class="absolute top-4 right-4 text-white text-2xl p-2"><i class="fa-solid fa-xmark"></i></button>
    <img id="modal-img" src="" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl object-contain">
</div>

<!-- Alert Modal (Info) -->
<div id="alert-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-3xl shadow-soft border border-[#E0E5D5] max-w-xs w-full p-6 text-center transform scale-95 transition-transform duration-300" id="alert-box">
        <div class="w-12 h-12 rounded-full bg-nook-green/20 flex items-center justify-center mx-auto mb-4 text-nook-green text-2xl">
            <i class="fa-solid fa-bell"></i>
        </div>
        <p id="alert-msg" class="text-gray-700 font-bold mb-6 text-sm leading-relaxed"></p>
        <button onclick="closeAlert()" class="bg-nook-green text-white w-full py-3 rounded-xl font-bold shadow-soft btn-press">
            æˆ‘çŸ¥é“äº†
        </button>
    </div>
</div>

<!-- Confirm Modal (Action) -->
<div id="confirm-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-3xl shadow-soft border border-[#E0E5D5] max-w-xs w-full p-6 text-center transform scale-95 transition-transform duration-300" id="confirm-box">
        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4 text-red-500 text-2xl">
            <i class="fa-solid fa-circle-question"></i>
        </div>
        <p id="confirm-msg" class="text-gray-700 font-bold mb-6 text-lg leading-relaxed">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</p>
        <div class="flex gap-3">
            <button onclick="closeConfirm()" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
            <button id="confirm-btn-yes" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold shadow-sm btn-press">ç¢ºå®š</button>
        </div>
    </div>
</div>

<nav class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur border-t border-[#E0E5D5] pb-safe pt-2 px-2 z-50">
    <div class="flex justify-around items-center max-w-md mx-auto">
        <button onclick="switchTab('view-plan')" class="nav-item active flex flex-col items-center p-2 w-16 transition-all duration-300">
            <i class="fa-solid fa-calendar-days text-xl text-gray-400 mb-1"></i><span class="text-[10px] text-gray-400">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('view-notes')" class="nav-item flex flex-col items-center p-2 w-16 transition-all duration-300">
            <i class="fa-solid fa-pen-to-square text-xl text-gray-400 mb-1"></i><span class="text-[10px] text-gray-400">ç­†è¨˜</span>
        </button>
        <button onclick="switchTab('view-wallet')" class="nav-item flex flex-col items-center p-2 w-16 transition-all duration-300">
            <div class="bg-nook-green rounded-full w-12 h-12 flex items-center justify-center -mt-6 border-4 border-[#F7F4EB] shadow-md">
                <i class="fa-solid fa-wallet text-xl text-white"></i>
            </div>
        </button>
        <button onclick="switchTab('view-lists')" class="nav-item flex flex-col items-center p-2 w-16 transition-all duration-300">
            <i class="fa-solid fa-suitcase text-xl text-gray-400 mb-1"></i><span class="text-[10px] text-gray-400">æº–å‚™</span>
        </button>
        <button onclick="switchTab('view-info')" class="nav-item flex flex-col items-center p-2 w-16 transition-all duration-300">
            <i class="fa-solid fa-circle-info text-xl text-gray-400 mb-1"></i><span class="text-[10px] text-gray-400">è³‡è¨Š</span>
        </button>
    </div>
    <div class="h-4 w-full"></div> 
</nav>

<script>
    // ==========================================
    // --- è¨­å®šå€ ---
    // ==========================================
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbw2dL2WyiTVZ9W2E46PUCuAyF0IuCL0LGpc8OdF4VwxVgJqKtlb1o9Yc_4Ydz9gOyalVg/exec";

    // ==========================================
    // --- è³‡æ–™æ ¸å¿ƒ ---
    // ==========================================
    
    // Default data structure
    const DEFAULT_DATA = {
        // Updated Prep Structure (Replacing old checklist)
        prepItems: [
            { id: 'prep-1', text: "è­·ç…§", category: "todo", owners: [], completed: false, image: null },
            { id: 'prep-2', text: "æ—¥å¹£", category: "todo", owners: [], completed: false, image: null },
            { id: 'prep-3', text: "ç¶²å¡", category: "todo", owners: [], completed: false, image: null }
        ],
        rate: 0.22,
        userList: [],
        expenses: [], 
        days: [
          {
            id: "d1", day: "D1", date: "01/02 (äº”)", location: "æ„›çŸ¥ç¸£",
            journals: [],
            activities: [
              { id: "a1-1", time: "06:30", title: "æ¡ƒæ©Ÿä¸€èˆªå»ˆé›†åˆ", type: "transport", city: "æ¡ƒåœ’", desc: "æ³°ç…èˆªç©º 2è™Ÿæ«ƒå°é›†åˆ (å°éŠï¼šæ—ä¸–è±ª)" },
              { id: "a1-2", time: "09:00", title: "æ­ä¹˜æ³°ç… SL398", type: "transport", city: "æ¡ƒåœ’", desc: "é£›å¾€åå¤å±‹ä¸­éƒ¨åœ‹éš›æ©Ÿå ´" },
              { id: "a1-3", time: "12:40", title: "æŠµé”åå¤å±‹", type: "transport", city: "å¸¸æ»‘", desc: "è¾¦ç†å…¥å¢ƒæ‰‹çºŒ" },
              { id: "a1-4", time: "15:00", title: "åå¤å±‹å¸‚å€è§€å…‰", type: "spot", city: "åå¤å±‹", desc: "è‡ªç”±æ¢ç´¢æˆ–é£¯åº—ä¼‘æ¯" },
              { id: "a1-5", time: "18:00", title: "å…¥ä½é£¯åº—", type: "stay", city: "åå¤å±‹", desc: "ä½å®¿: åå¤å±‹å¸Œçˆ¾é “é…’åº— (Nagoya Hilton)" }
            ]
          },
          {
            id: "d2", day: "D2", date: "01/03 (å…­)", location: "å²é˜œç¸£",
            journals: [],
            activities: [
              { id: "a2-1", time: "09:00", title: "æƒ é‚£å³½å±•æœ›å°", type: "spot", city: "æƒ é‚£", desc: "å¤§è‡ªç„¶ä¾µè•è€Œå½¢æˆçš„æ–·å´–çµ•å£ï¼Œå¥‡å²©æ€ªçŸ³" },
              { id: "a2-2", time: "12:00", title: "é¦¬ç± å®¿æˆ–å¦»ç± å®¿", type: "spot", city: "ä¸­æ´¥å·", desc: "æ±Ÿæˆ¶æ™‚ä»£å®¿é©›é¢¨æƒ…ï¼Œå¤è¡—æ•£ç­–" },
              { id: "a2-3", time: "17:00", title: "å…¥ä½æº«æ³‰é£¯åº—", type: "stay", city: "å¾¡å²³", desc: "ä½å®¿: å¾¡å²³ Golf & Resort (äº«ç”¨æœƒå¸­æ–™ç†)" }
            ]
          },
          {
            id: "d3", day: "D3", date: "01/04 (æ—¥)", location: "å²é˜œç¸£",
            journals: [],
            activities: [
              { id: "a3-1", time: "09:00", title: "æ–°ç©—é«˜é›™å±¤çºœè»Š", type: "spot", city: "é«˜å±±", highlight: true, desc: "æ—¥æœ¬æœ€æ—©é›™å±¤çºœè»Šï¼Œçœºæœ›é˜¿çˆ¾å‘æ–¯å±±é›ªæ™¯ (ç™½éŠ€é›ªéŠå»£å ´)" },
              { id: "a3-2", time: "13:00", title: "é£›é©’é«˜å±±å°äº¬éƒ½", type: "spot", city: "é«˜å±±", desc: "ä¸Šä¸‰ä¹‹ç”ºæ•£ç­– (å¤ä¹‹ç”ºä¸¦)ï¼Œç±³å…¶æ—ä¸‰æ˜Ÿæ™¯é»" },
              { id: "a3-3", time: "17:00", title: "å…¥ä½æº«æ³‰é£¯åº—", type: "stay", city: "é«˜å±±", desc: "ä½å®¿: Route INN Grantia é£›é©’é«˜å±±" }
            ]
          },
          {
            id: "d4", day: "D4", date: "01/05 (ä¸€)", location: "åŒ—é™¸",
            journals: [],
            activities: [
              { id: "a4-1", time: "09:00", title: "åº„å·å³½éŠèˆ¹", type: "spot", city: "å¯Œå±±", desc: "æ­èˆ¹æ¬£è³å¹½ç„¶æ·±é‚çš„æºªè°·èˆ‡é›ªæ™¯" },
              { id: "a4-2", time: "12:00", title: "è¿‘æ±Ÿç”ºå¸‚å ´", type: "food", city: "é‡‘æ¾¤", desc: "é‡‘æ¾¤å»šæˆ¿ï¼Œæµ·é®®å·¡ç¦® (åˆé¤è‡ªç†)" },
              { id: "a4-3", time: "14:00", title: "å…¼å…­åœ’ & å‚˜æ¾é›ªåŠ", type: "spot", city: "é‡‘æ¾¤", highlight: true, desc: "æ—¥æœ¬ä¸‰å¤§ååœ’ä¹‹ä¸€ï¼Œå†¬å­£é™å®šé›ªåŠç¾æ™¯" },
              { id: "a4-4", time: "16:00", title: "æ±èŒ¶å±‹è¡—", type: "spot", city: "é‡‘æ¾¤", desc: "æ±Ÿæˆ¶æ™‚ä»£èŒ¶å±‹è¡—é¢¨æƒ…ï¼Œåœ‹å®¶æŒ‡å®šæ–‡åŒ–è²¡" },
              { id: "a4-5", time: "18:00", title: "å…¥ä½é‡‘æ¾¤é£¯åº—", type: "stay", city: "é‡‘æ¾¤", desc: "ä½å®¿: é‡‘æ¾¤ T-MARK HOTEL" }
            ]
          },
          {
            id: "d5", day: "D5", date: "01/06 (äºŒ)", location: "ä¸‰é‡ç¸£",
            journals: [],
            activities: [
              { id: "a5-1", time: "09:00", title: "ç™½å·é„‰åˆæŒæ‘", type: "spot", city: "ç™½å·é„‰", highlight: true, desc: "ä¸–ç•Œæ–‡åŒ–éºç”¢ï¼Œå¤¢å¹»ç«¥è©±è–‘é¤…å±‹é›ªæ™¯" },
              { id: "a5-2", time: "13:00", title: "å…ç¨…åº—", type: "shopping", city: "åå¤å±‹", desc: "è³¼ç‰©è¡Œç¨‹" },
              { id: "a5-3", time: "14:30", title: "çˆµå£«ä¹‹å¤¢é•·å³¶ Outlet", type: "shopping", city: "æ¡‘å", desc: "ä¸‰äº• OUTLET PARKï¼Œç˜‹ç‹‚è¡€æ‹¼" },
              { id: "a5-4", time: "17:30", title: "åèŠ±ä¹‹é‡Œå¤¢å¹»é»ç‡ˆ", type: "spot", city: "æ¡‘å", highlight: true, desc: "æ—¥æœ¬æœ€å¤§è¦æ¨¡ LED å½©ç‡ˆæ…¶å…¸ (å…‰ä¹‹è¿´å»Š)" },
              { id: "a5-5", time: "20:00", title: "å…¥ä½åå¤å±‹é£¯åº—", type: "stay", city: "åå¤å±‹", desc: "ä½å®¿: åå¤å±‹ Centmain é£¯åº—" }
            ]
          },
          {
            id: "d6", day: "D6", date: "01/07 (ä¸‰)", location: "æ„›çŸ¥ç¸£",
            journals: [],
            activities: [
              { id: "a6-1", time: "09:00", title: "è‡ªç”±æ´»å‹•", type: "spot", city: "åå¤å±‹", desc: "æœ€å¾Œè£œè²¨æˆ–ä¼‘æ¯" },
              { id: "a6-2", time: "11:30", title: "å‰å¾€ä¸­éƒ¨åœ‹éš›æ©Ÿå ´", type: "transport", city: "å¸¸æ»‘", desc: "è¾¦ç†ç™»æ©Ÿæ‰‹çºŒ" },
              { id: "a6-3", time: "13:40", title: "æ­ä¹˜æ³°ç… SL399", type: "transport", city: "å¸¸æ»‘", desc: "é£›å¾€æ¡ƒåœ’" },
              { id: "a6-4", time: "16:00", title: "æŠµé”æ¡ƒåœ’æ©Ÿå ´", type: "transport", city: "æ¡ƒåœ’", desc: "æº«æš–çš„å®¶" }
            ]
          }
        ]
    };

    let appData = {};
    let currentUser = null;
    let currentDayIndex = 0;
    let isEditMode = false;
    let sortableInstance = null;
    let tempWalletPhoto = null;
    let editingExpenseId = null;
    let weatherLoaded = false;
    let confirmCallback = null;
    
    // Wallet States
    let walletCurrency = 'JPY';
    let walletMethod = 'ç¾é‡‘';
    let walletSelectedUser = null;
    let walletFilterUser = 'all';

    // Prep States
    let prepCategory = 'todo';
    let prepFilterUser = 'all';
    let newPrepOwners = [];
    let tempPrepPhoto = null;

    // Weather Configuration
    const WEATHER_LOCATIONS = [
        { name: 'åå¤å±‹ (æ„›çŸ¥)', lat: 35.1815, lon: 136.9066 },
        { name: 'é«˜å±± (å²é˜œ)', lat: 36.1408, lon: 137.2513 },
        { name: 'é‡‘æ¾¤ (çŸ³å·)', lat: 36.5613, lon: 136.6562 },
        { name: 'ç™½å·é„‰ (å²é˜œ)', lat: 36.2598, lon: 136.9059 }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        checkLoginState();
    });

    // --- Login Logic ---
    function checkLoginState() {
        const savedUser = localStorage.getItem('travelApp_user');
        if (savedUser) {
            currentUser = savedUser;
            initApp();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
        }
    }

    function performLogin() {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        const btn = document.getElementById('login-btn');
        const msg = document.getElementById('login-msg');
        
        if (!u || !p) { msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        
        if (GAS_API_URL.includes("è«‹åœ¨æ­¤å¡«å…¥")) {
             showAlert("æ¸¬è©¦æ¨¡å¼ï¼šè«‹å…ˆè¨­å®š GAS URLã€‚ç›®å‰ä»¥ 'admin' ç™»å…¥ã€‚");
             completeLogin('admin');
             return;
        }

        btn.innerText = "é©—è­‰ä¸­...";
        btn.disabled = true;

        fetch(GAS_API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'login', username: u, password: p })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                completeLogin(data.username);
            } else {
                msg.innerText = data.message;
                btn.innerText = "é€²å…¥ App";
                btn.disabled = false;
            }
        })
        .catch(err => {
            msg.innerText = "é€£ç·šéŒ¯èª¤";
            btn.innerText = "é€²å…¥ App";
            btn.disabled = false;
        });
    }

    function completeLogin(username) {
        currentUser = username;
        walletSelectedUser = currentUser; // Default payer
        localStorage.setItem('travelApp_user', username);
        document.getElementById('login-screen').style.display = 'none';
        initApp();
    }
    
    function logout() {
        localStorage.removeItem('travelApp_user');
        location.reload();
    }

    function initApp() {
        loadData();
        renderHeaderInfo();
        renderDayTabs();
        renderItinerary();
        renderNoteDayTabs();
        renderNotes();
        // Wallet
        document.getElementById('exchange-rate').value = appData.rate || 0.22;
        document.getElementById('expense-date').valueAsDate = new Date();
        renderWalletUsers();
        renderWalletFilters();
        loadExpenses();
        // Prep
        renderPrepUI();
        renderPrepList();
        
        const badge = document.getElementById('header-user-badge');
        badge.innerText = currentUser;
        badge.classList.remove('opacity-0');
        
        const updateClock = () => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:false}); };
        updateClock();
        setInterval(updateClock, 1000);
    }

    // --- é›²ç«¯åŒæ­¥ ---
    function syncToCloud() {
        if (GAS_API_URL.includes("è«‹åœ¨æ­¤å¡«å…¥")) { showAlert("è«‹å…ˆè¨­å®š URL"); return; }
        const btn = document.getElementById('sync-btn');
        const icon = btn.innerHTML;
        btn.innerHTML = '<span class="spinner"></span>';
        
        // Deep copy data to avoid modifying local state
        let cleanData = JSON.parse(JSON.stringify(appData));
        
        // Data Cleanup Strategy:
        // 1. Remove heavy Base64 images from all sections
        if (cleanData.days) {
            cleanData.days.forEach(day => { 
                if(day.activities) {
                    day.activities.forEach(act => delete act.image); 
                }
            });
        }
        
        if(cleanData.expenses) {
            cleanData.expenses.forEach(ex => delete ex.photo);
        }
        
        if(cleanData.prepItems) {
            cleanData.prepItems.forEach(item => delete item.image);
        }

        fetch(GAS_API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'save_all', appData: cleanData })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                showAlert("âœ… ä¸Šå‚³æˆåŠŸï¼");
            } else {
                showAlert("âŒ ä¸Šå‚³å¤±æ•—ï¼š" + data.message);
            }
            btn.innerHTML = icon;
        })
        .catch(err => {
            showAlert("âŒ ä¸Šå‚³å¤±æ•— (ç¶²çµ¡éŒ¯èª¤)ï¼š" + err);
            btn.innerHTML = icon;
        });
    }

    function loadFromCloud() {
        if (GAS_API_URL.includes("è«‹åœ¨æ­¤å¡«å…¥")) { showAlert("è«‹å…ˆè¨­å®š URL"); return; }
        showConfirm("å¾é›²ç«¯è®€å–ï¼Ÿæœ¬åœ°è®Šæ›´å°‡éºå¤±ã€‚", () => {
            const btn = document.getElementById('load-btn');
            const icon = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span>';

            fetch(GAS_API_URL + '?action=get_all')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success' && data.appData) {
                    appData = data.appData;
                    
                    // Robust Data Merging
                    if (!appData.prepItems) appData.prepItems = DEFAULT_DATA.prepItems;
                    if (data.users) appData.userList = data.users; 
                    if (!appData.days) appData.days = DEFAULT_DATA.days;
                    
                    appData.days.forEach(day => { if (!day.journals) day.journals = []; });
                    
                    // Merge expenses from separate sheet if available
                    if (data.expenses && data.expenses.length > 0) {
                       appData.expenses = data.expenses.map((e, idx) => ({
                           id: Date.now() + idx,
                           item: e.item,
                           currency: e.currency,
                           amount: e.amount,
                           twd: e.twd,
                           method: e.method,
                           location: e.location,
                           user: e.user,
                           date: e.date,
                           note: e.note
                       }));
                    }
                    
                    saveData();
                    
                    // Force refresh all views
                    renderItinerary();
                    renderDayTabs();
                    renderNoteDayTabs();
                    renderNotes();
                    renderPrepUI();
                    renderPrepList();
                    renderWalletUsers(); 
                    renderWalletFilters();
                    loadExpenses(); 
                    
                    showAlert("âœ… åŒæ­¥å®Œæˆï¼");
                } else {
                    showAlert("âš ï¸ é›²ç«¯ç„¡è³‡æ–™æˆ–æ ¼å¼éŒ¯èª¤");
                }
                btn.innerHTML = icon;
            })
            .catch(err => {
                showAlert("âŒ ä¸‹è¼‰å¤±æ•—ï¼š" + err);
                btn.innerHTML = icon;
            });
        });
    }

    // --- LocalStorage ---
    function loadData() {
        const saved = localStorage.getItem('travelApp_data_v6'); 
        if (saved) {
            appData = JSON.parse(saved);
            // Default fallbacks
            if (!appData.expenses) appData.expenses = [];
            if (!appData.rate) appData.rate = 0.22;
            if (!appData.userList) appData.userList = [];
            if (!appData.prepItems) appData.prepItems = DEFAULT_DATA.prepItems;
        } else {
            appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
            saveData();
        }
    }
    function saveData() { localStorage.setItem('travelApp_data_v6', JSON.stringify(appData)); }

    // --- Preparation Logic (Fixed Deletion Bug) ---
    function renderPrepUI() {
        const userContainer = document.getElementById('prep-filter-container');
        const newUserTagsContainer = document.getElementById('prep-new-user-tags');
        
        let users = appData.userList && appData.userList.length > 0 ? appData.userList : [currentUser];
        if(!users.includes(currentUser)) users = [currentUser, ...users];
        
        // Render Filters
        let filterHtml = `<button onclick="filterPrepUser('all')" class="flex-shrink-0 px-3 py-1 rounded-full text-xs font-bold transition-all ${prepFilterUser === 'all' ? 'bg-[#6B5B45] text-white' : 'bg-white text-gray-500 border border-gray-200'}">å…¨éƒ¨</button>`;
        users.forEach(u => {
            const isSel = prepFilterUser === u;
            filterHtml += `<button onclick="filterPrepUser('${u}')" class="flex-shrink-0 px-3 py-1 rounded-full text-xs font-bold transition-all ${isSel ? 'bg-[#6B5B45] text-white' : 'bg-white text-gray-500 border border-gray-200'}">${u}</button>`;
        });
        userContainer.innerHTML = filterHtml;

        // Render New Item Tags
        let tagsHtml = '';
        users.forEach(u => {
            const isSelected = newPrepOwners.includes(u);
            const bgClass = isSelected ? 'bg-nook-green text-white' : 'bg-gray-100 text-gray-400';
            tagsHtml += `<button onclick="toggleNewPrepOwner('${u}')" class="flex-shrink-0 px-2 py-1 rounded-md text-[10px] font-bold transition-all ${bgClass}">${isSelected ? '<i class="fa-solid fa-check mr-1"></i>' : ''}${u}</button>`;
        });
        newUserTagsContainer.innerHTML = tagsHtml;
    }

    function setPrepCategory(cat) {
        prepCategory = cat;
        // Update Tabs UI
        ['todo', 'luggage', 'wishlist', 'shopping'].forEach(c => {
            const btn = document.getElementById(`tab-prep-${c}`);
            if(c === cat) {
                btn.className = "flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-bold transition-all bg-nook-green text-white";
            } else {
                btn.className = "flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-bold transition-all text-gray-500 hover:bg-gray-100";
            }
        });
        
        // Show/Hide Link Input
        const linkInput = document.getElementById('prep-link');
        if (cat === 'wishlist') {
            linkInput.classList.remove('hidden');
        } else {
            linkInput.classList.add('hidden');
        }

        renderPrepList();
    }

    function filterPrepUser(u) {
        prepFilterUser = u;
        renderPrepUI();
        renderPrepList();
    }

    function toggleNewPrepOwner(u) {
        if(newPrepOwners.includes(u)) {
            newPrepOwners = newPrepOwners.filter(user => user !== u);
        } else {
            newPrepOwners.push(u);
        }
        renderPrepUI();
    }

    function handlePrepPhoto(input) {
         if (input.files && input.files[0]) {
            const check = document.getElementById('prep-photo-check');
            check.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800; 
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    tempPrepPhoto = canvas.toDataURL('image/jpeg', 0.6);
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function addPrepItem() {
        const input = document.getElementById('prep-input');
        const linkInput = document.getElementById('prep-link');
        const text = input.value.trim();
        const link = linkInput.value.trim();
        
        if(!text) return;

        // Ensure ID is a string to prevent type coercion issues in onclick handlers
        const newItem = {
            id: 'prep-' + Date.now(), 
            text: text,
            category: prepCategory,
            owners: newPrepOwners.length > 0 ? [...newPrepOwners] : [], 
            completed: false,
            image: tempPrepPhoto,
            link: (prepCategory === 'wishlist' && link) ? link : null
        };

        appData.prepItems.push(newItem);
        input.value = '';
        linkInput.value = '';
        newPrepOwners = []; // Reset selected users
        tempPrepPhoto = null;
        document.getElementById('prep-photo-check').classList.add('hidden');
        document.getElementById('prep-photo').value = '';
        
        saveData();
        renderPrepUI();
        renderPrepList();
    }

    function renderPrepList() {
        const container = document.getElementById('prep-list-container');
        
        let filtered = appData.prepItems.filter(item => item.category === prepCategory);
        if(prepFilterUser !== 'all') {
            filtered = filtered.filter(item => item.owners.length === 0 || item.owners.includes(prepFilterUser));
        }

        if(filtered.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-300 py-8 text-sm">æ­¤åˆ†é¡å°šç„¡é …ç›®</div>`;
            return;
        }

        let html = '';
        filtered.forEach(item => {
            const checkedClass = item.completed ? 'opacity-50' : '';
            const textClass = item.completed ? 'line-through text-gray-400' : 'text-gray-700';
            
            // Generate Owner Tags
            let ownerTags = '';
            if(item.owners.length > 0) {
                item.owners.forEach(u => {
                    ownerTags += `<span class="bg-nook-green text-white text-[10px] px-2 py-0.5 rounded-full font-bold mr-1">${u}</span>`;
                });
            } else {
                ownerTags += `<span class="bg-gray-100 text-gray-400 text-[10px] px-2 py-0.5 rounded-full">å…¨é«”</span>`;
            }
            
            // Image
            const imgHtml = item.image ? `<img src="${item.image}" onclick="showImageModal('${item.image}')" class="w-12 h-12 rounded-lg object-cover border border-gray-200 cursor-pointer flex-shrink-0">` : '';
            
            // Link
            const linkHtml = item.link ? `<a href="${item.link}" target="_blank" class="inline-block bg-blue-50 text-blue-500 text-[10px] px-2 py-1 rounded-md font-bold mt-1 btn-press hover:bg-blue-100 transition"><i class="fa-solid fa-location-dot mr-1"></i>åœ°åœ–</a>` : '';

            html += `
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex items-start gap-3 ${checkedClass}">
                <button onclick="togglePrepCheck('${item.id}')" class="mt-1 w-6 h-6 rounded-lg border-2 ${item.completed ? 'bg-nook-green border-nook-green text-white' : 'border-gray-300 text-transparent'} flex items-center justify-center transition-all flex-shrink-0">
                    <i class="fa-solid fa-check text-xs"></i>
                </button>
                ${imgHtml}
                <div class="flex-1 min-w-0">
                    <div class="font-bold text-lg mb-1 leading-tight ${textClass}">${item.text}</div>
                    ${linkHtml}
                    <div class="flex flex-wrap gap-1 mt-1">
                        ${ownerTags}
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="deletePrepItem('${item.id}')" class="text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function togglePrepCheck(id) {
        // Enforce string comparison to handle both legacy numeric IDs and new string IDs
        const item = appData.prepItems.find(i => String(i.id) === String(id));
        if(item) {
            item.completed = !item.completed;
            saveData();
            renderPrepList();
        }
    }

    function deletePrepItem(id) {
        showConfirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ", () => {
            // Fix: Enforce string comparison to ensure item is found and removed regardless of type
            appData.prepItems = appData.prepItems.filter(i => String(i.id) !== String(id));
            saveData();
            renderPrepList();
        });
    }

    // --- Wallet Logic (Redesigned) ---
    function setWalletMode(mode) {
        if(mode === 'input') {
            document.getElementById('wallet-input-view').classList.remove('hidden');
            document.getElementById('wallet-list-view').classList.add('hidden');
            document.getElementById('tab-wallet-input').classList.add('bg-nook-green', 'text-white');
            document.getElementById('tab-wallet-input').classList.remove('text-gray-500');
            document.getElementById('tab-wallet-list').classList.remove('bg-nook-green', 'text-white');
            document.getElementById('tab-wallet-list').classList.add('text-gray-500');
        } else {
            document.getElementById('wallet-input-view').classList.add('hidden');
            document.getElementById('wallet-list-view').classList.remove('hidden');
            document.getElementById('tab-wallet-list').classList.add('bg-nook-green', 'text-white');
            document.getElementById('tab-wallet-list').classList.remove('text-gray-500');
            document.getElementById('tab-wallet-input').classList.remove('bg-nook-green', 'text-white');
            document.getElementById('tab-wallet-input').classList.add('text-gray-500');
            loadExpenses(); // Fix: Load data when switching to list view
            renderExpenseSummary();
        }
    }

    function saveRate() {
        appData.rate = document.getElementById('exchange-rate').value;
        saveData();
        calculateEquivalent();
        renderExpenseSummary();
    }
    
    function selectCurrency(curr) {
        walletCurrency = curr;
        // Update UI
        if(curr === 'JPY') {
            document.getElementById('curr-btn-jpy').className = 'flex-1 py-2 rounded-xl text-sm font-bold border border-nook-green bg-nook-green text-white transition';
            document.getElementById('curr-btn-twd').className = 'flex-1 py-2 rounded-xl text-sm font-bold border border-gray-200 text-gray-500 bg-white hover:bg-gray-50 transition';
        } else {
            document.getElementById('curr-btn-twd').className = 'flex-1 py-2 rounded-xl text-sm font-bold border border-nook-green bg-nook-green text-white transition';
            document.getElementById('curr-btn-jpy').className = 'flex-1 py-2 rounded-xl text-sm font-bold border border-gray-200 text-gray-500 bg-white hover:bg-gray-50 transition';
        }
        calculateEquivalent();
    }
    
    function selectMethod(method) {
        walletMethod = method;
        const ids = {'ç¾é‡‘':'method-btn-cash', 'ä¿¡ç”¨å¡':'method-btn-card', 'è¡Œå‹•æ”¯ä»˜':'method-btn-mobile'};
        for(const k in ids) {
             const btn = document.getElementById(ids[k]);
             if(k === method) {
                 btn.className = 'flex-1 py-2 rounded-xl text-xs font-bold border border-nook-green text-nook-green bg-green-50 transition';
             } else {
                 btn.className = 'flex-1 py-2 rounded-xl text-xs font-bold border border-gray-200 text-gray-500 bg-white hover:bg-gray-50 transition';
             }
        }
    }
    
    function calculateEquivalent() {
        const amt = parseFloat(document.getElementById('expense-amount').value) || 0;
        let equiv = 0;
        if (walletCurrency === 'JPY') {
            equiv = Math.round(amt * appData.rate);
        } else {
            equiv = amt; // TWD 1:1
        }
        document.getElementById('expense-equiv').innerText = equiv;
    }
    
    function renderWalletUsers() {
        const container = document.getElementById('wallet-users-container');
        let html = '';
        
        // Use userList from DB if available, otherwise just currentUser
        let availableUsers = appData.userList && appData.userList.length > 0 
            ? appData.userList 
            : [currentUser];
            
        availableUsers.forEach(u => {
            const isSelected = u === walletSelectedUser;
            const style = isSelected 
                ? 'bg-nook-dark text-white shadow-md' 
                : 'bg-white text-gray-500 border border-gray-200';
            
            html += `<button onclick="selectWalletUser('${u}')" class="flex items-center gap-1 px-3 py-2 rounded-full text-xs font-bold whitespace-nowrap transition ${style}">
                <div class="w-4 h-4 rounded-full ${isSelected ? 'bg-white/20' : 'bg-gray-100'} flex items-center justify-center text-[8px]">${u.charAt(0)}</div>
                ${u}
            </button>`;
        });
        
        if (!appData.userList || appData.userList.length === 0) {
             html += `<div class="text-[10px] text-gray-400 flex items-center ml-2 border-l pl-2"><i class="fa-solid fa-triangle-exclamation mr-1"></i>æŒ‰é›²ç«¯è®€å–ä»¥åŒæ­¥æˆå“¡</div>`;
        }
        
        container.innerHTML = html;
    }
    
    function selectWalletUser(u) {
        walletSelectedUser = u;
        renderWalletUsers();
    }

    function renderWalletFilters() {
        const container = document.getElementById('filter-users-container');
        let html = '';
        
        // Use userList from DB if available, otherwise just currentUser
        let availableUsers = appData.userList && appData.userList.length > 0 
            ? appData.userList 
            : [currentUser];
        
        // Add "All" option
        const isAll = walletFilterUser === 'all';
        html += `<button onclick="filterWalletUser('all')" class="px-3 py-1 text-xs rounded-md transition whitespace-nowrap ${isAll ? 'bg-nook-green text-white font-bold' : 'text-gray-400'}">å…¨é«”</button>`;
        
        availableUsers.forEach(u => {
            const isSel = u === walletFilterUser;
            html += `<button onclick="filterWalletUser('${u}')" class="px-3 py-1 text-xs rounded-md transition whitespace-nowrap ${isSel ? 'bg-nook-green text-white font-bold' : 'text-gray-400'}">${u}</button>`;
        });
        container.innerHTML = html;
    }

    function filterWalletUser(u) {
        walletFilterUser = u;
        renderWalletFilters();
        loadExpenses();
        // Update summary title
        document.getElementById('summary-user-name').innerText = u === 'all' ? 'å…¨é«”' : u;
    }

    function handleWalletPhoto(input) {
         if (input.files && input.files[0]) {
            const check = document.getElementById('photo-check');
            check.innerText = "...";
            check.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800; 
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    tempWalletPhoto = canvas.toDataURL('image/jpeg', 0.6);
                    check.innerHTML = '<i class="fa-solid fa-check"></i>';
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function addExpense() {
        const item = document.getElementById('expense-item').value;
        const amount = document.getElementById('expense-amount').value;
        const date = document.getElementById('expense-date').value;
        const location = document.getElementById('expense-location').value;
        
        if(!item || !amount || !date) { showAlert("è«‹å¡«å¯«é‡‘é¡ã€é …ç›®èˆ‡æ—¥æœŸ"); return; }
        
        const equiv = parseInt(document.getElementById('expense-equiv').innerText);
        
        const expenseData = {
            date: date.replace(/-/g, '/'),
            item: item,
            currency: walletCurrency,
            amount: parseFloat(amount),
            twd: equiv,
            method: walletMethod,
            location: location,
            user: walletSelectedUser || currentUser,
            note: ''
        };

        appData.expenses.unshift({
            id: Date.now(),
            ...expenseData,
            photo: tempWalletPhoto
        });
        
        if (!GAS_API_URL.includes("è«‹åœ¨æ­¤å¡«å…¥")) {
            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'add_expense', ...expenseData })
            }).catch(e => console.log("Sync Error", e));
        }

        // Reset UI partially
        document.getElementById('expense-item').value = '';
        document.getElementById('expense-amount').value = '';
        document.getElementById('expense-location').value = '';
        document.getElementById('expense-equiv').innerText = '0';
        document.getElementById('photo-check').classList.add('hidden');
        tempWalletPhoto = null;
        
        saveData();
        loadExpenses();
        showAlert("è¨˜å¸³æˆåŠŸï¼");
    }

    function loadExpenses() {
        const list = document.getElementById('expense-list');
        
        // Filter
        let filtered = appData.expenses;
        if (walletFilterUser !== 'all') {
            filtered = filtered.filter(e => e.user === walletFilterUser);
        }

        if (filtered.length === 0) { 
            list.innerHTML = '<div class="text-center text-gray-400 text-sm py-10">å°šç„¡ç´€éŒ„</div>'; 
            renderExpenseSummary(); 
            return; 
        }

        let html = '';
        // Group by Date
        const grouped = {};
        filtered.forEach(ex => {
             const d = ex.date;
             if(!grouped[d]) grouped[d] = [];
             grouped[d].push(ex);
        });

        // Sort dates desc
        const dates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));

        dates.forEach(date => {
            // Calculate daily total (TWD)
            const dayTotal = grouped[date].reduce((acc, curr) => acc + curr.twd, 0);
            
            html += `<div class="mb-4">
                <div class="flex justify-between items-center px-1 mb-2">
                    <span class="text-xs bg-blue-50 text-blue-500 px-2 py-0.5 rounded-full font-bold">${date}</span>
                    <span class="text-xs text-gray-400 font-bold">æœ¬æ—¥å°è¨ˆ: NT$ ${dayTotal}</span>
                </div>`;
            
            grouped[date].forEach(ex => {
                const isJPY = ex.currency === 'JPY';
                const amtDisplay = isJPY ? `Â¥ ${ex.amount.toLocaleString()}` : `NT$ ${ex.amount.toLocaleString()}`;
                const subDisplay = isJPY ? `â‰ˆ NT$ ${ex.twd}` : '';
                const photoIcon = ex.photo ? `<img src="${ex.photo}" onclick="showImageModal('${ex.photo}')" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm cursor-pointer">` : `<div class="w-10 h-10 rounded-full bg-nook-green/10 flex items-center justify-center text-nook-green"><i class="fa-solid fa-bag-shopping"></i></div>`;
                
                html += `
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex items-center gap-3 mb-2">
                    ${photoIcon}
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-gray-700 truncate">${ex.item}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 rounded">${ex.user}</span>
                            <span class="text-[10px] text-gray-400">${ex.method}</span>
                            ${ex.location ? `<span class="text-[10px] text-blue-400"><i class="fa-solid fa-location-dot mr-0.5"></i>${ex.location}</span>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold font-mono text-lg text-gray-700">${amtDisplay}</div>
                        <div class="text-[10px] text-gray-400">${subDisplay}</div>
                    </div>
                    <button onclick="deleteExpense(${ex.id})" class="text-gray-300 hover:text-red-400 ml-1 px-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>`;
            });
            html += `</div>`;
        });
        
        list.innerHTML = html;
        renderExpenseSummary();
    }
    
    function renderExpenseSummary() {
        // Calculate based on Filter
        let targetExpenses = appData.expenses;
        if(walletFilterUser !== 'all') {
            targetExpenses = targetExpenses.filter(e => e.user === walletFilterUser);
        }

        const totalTWD = targetExpenses.reduce((acc, curr) => acc + curr.twd, 0);
        const totalJPY = targetExpenses.filter(e => e.currency === 'JPY').reduce((acc, curr) => acc + curr.amount, 0);

        document.getElementById('summary-total-twd').innerText = totalTWD.toLocaleString();
        document.getElementById('summary-total-jpy').innerText = totalJPY.toLocaleString();
        document.getElementById('summary-rate').innerText = appData.rate;
    }

    function deleteExpense(id) { 
        showConfirm("ç¢ºå®šåˆªé™¤é€™ç­†æ¶ˆè²»ï¼Ÿ", () => {
            appData.expenses = appData.expenses.filter(e => e.id !== id); 
            saveData(); 
            loadExpenses(); 
        });
    }
    
    function resetPhotoUI() { document.getElementById('photo-label').innerText = "ç…§ç‰‡"; document.getElementById('photo-label').classList.remove('text-nook-green'); tempWalletPhoto=null; }
    function cancelEdit() { 
        editingExpenseId = null;
        document.getElementById('expense-item').value = '';
        document.getElementById('expense-jpy').value = '';
        document.getElementById('expense-form-title').innerHTML = '<i class="fa-solid fa-user-tag text-nook-accent mr-1"></i>è¨˜ä¸€ç­†';
        const btn = document.getElementById('save-expense-btn');
        btn.innerText = "å„²å­˜";
        btn.classList.replace('bg-nook-accent', 'bg-nook-dark');
        document.getElementById('cancel-edit-btn').classList.add('hidden');
        resetPhotoUI();
    }

    // --- Journal / Notes Logic (New) ---
    function renderNoteDayTabs() {
        const container = document.getElementById('note-day-tabs');
        if(!appData.days) return; 
        let html = '';
        appData.days.forEach((d, idx) => {
            const activeClass = idx === currentDayIndex ? 'bg-nook-green text-white shadow-md' : 'bg-gray-100 text-gray-500 border border-gray-200';
            html += `<button onclick="selectDay(${idx})" class="flex-shrink-0 px-4 py-2 rounded-xl transition-all ${activeClass}"><div class="text-xs font-bold">${d.day}</div></button>`;
        });
        container.innerHTML = html;
    }
    
    function renderNotes() {
        const container = document.getElementById('note-list');
        const dayData = appData.days[currentDayIndex];
        if(!dayData.journals || dayData.journals.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">ä»Šå¤©é‚„æ²’æœ‰ç­†è¨˜ï¼Œä¾†å¯«ç¬¬ä¸€ç­†å§ï¼</div>';
            return;
        }
        
        let html = '';
        // sort by time desc
        const sorted = [...dayData.journals].reverse();
        
        sorted.forEach(note => {
            const isMe = note.user === currentUser;
            const delBtn = isMe ? `<button onclick="deleteNote(${note.id})" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>` : '';
            
            html += `
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-3">
                <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-50">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-nook-green/20 text-nook-green flex items-center justify-center text-xs font-bold">${note.user.charAt(0).toUpperCase()}</div>
                        <span class="font-bold text-gray-700 text-sm">${note.user}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-gray-400">${note.time}</span>
                        ${delBtn}
                    </div>
                </div>
                <p class="text-gray-600 text-sm whitespace-pre-wrap leading-relaxed">${note.content}</p>
            </div>`;
        });
        container.innerHTML = html;
    }
    
    function addNote() {
        const input = document.getElementById('note-input');
        const content = input.value.trim();
        if(!content) return;
        
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        
        const newNote = {
            id: Date.now(),
            user: currentUser,
            content: content,
            time: timeStr
        };
        
        if(!appData.days[currentDayIndex].journals) appData.days[currentDayIndex].journals = [];
        appData.days[currentDayIndex].journals.push(newNote);
        
        input.value = '';
        saveData();
        renderNotes();
    }
    
    function deleteNote(id) {
        showConfirm("åˆªé™¤é€™å‰‡ç­†è¨˜ï¼Ÿ", () => {
            const day = appData.days[currentDayIndex];
            day.journals = day.journals.filter(n => n.id !== id);
            saveData();
            renderNotes();
        });
    }

    // --- Weather Logic (New) ---
    async function fetchWeather() {
        if (weatherLoaded) return;
        const container = document.getElementById('weather-list');
        container.innerHTML = '<div class="text-center text-gray-400 text-xs py-2"><span class="spinner"></span>è¼‰å…¥ä¸­...</div>';

        let html = '';
        try {
            for (const loc of WEATHER_LOCATIONS) {
                // Open-Meteo API (Free, no key)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current_weather=true&timezone=Asia%2FTokyo`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.current_weather) {
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    const iconInfo = getWeatherIcon(code);
                    
                    html += `
                    <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm">
                        <div class="font-bold text-gray-700 text-sm">${loc.name}</div>
                        <div class="flex items-center gap-3">
                            <div class="text-2xl weather-icon-anim ${iconInfo.color}">${iconInfo.icon}</div>
                            <div class="font-mono font-bold text-lg text-gray-600">${temp}Â°</div>
                        </div>
                    </div>`;
                }
            }
            container.innerHTML = html;
            weatherLoaded = true;
        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="text-center text-red-400 text-xs py-2">å¤©æ°£è¼‰å…¥å¤±æ•—</div>';
        }
    }

    function getWeatherIcon(code) {
        // WMO Weather interpretation codes (https://open-meteo.com/en/docs)
        if (code === 0) return { icon: '<i class="fa-solid fa-sun"></i>', color: 'text-weather-sun' }; // Clear
        if (code >= 1 && code <= 3) return { icon: '<i class="fa-solid fa-cloud-sun"></i>', color: 'text-weather-cloud' }; // Cloudy
        if (code >= 45 && code <= 48) return { icon: '<i class="fa-solid fa-smog"></i>', color: 'text-gray-400' }; // Fog
        if (code >= 51 && code <= 67) return { icon: '<i class="fa-solid fa-cloud-rain"></i>', color: 'text-weather-rain' }; // Rain
        if (code >= 71 && code <= 77) return { icon: '<i class="fa-regular fa-snowflake"></i>', color: 'text-blue-300' }; // Snow
        if (code >= 80 && code <= 82) return { icon: '<i class="fa-solid fa-cloud-showers-heavy"></i>', color: 'text-weather-rain' }; // Showers
        if (code >= 85 && code <= 86) return { icon: '<i class="fa-regular fa-snowflake"></i>', color: 'text-blue-300' }; // Snow showers
        if (code >= 95) return { icon: '<i class="fa-solid fa-bolt"></i>', color: 'text-yellow-500' }; // Thunderstorm
        return { icon: '<i class="fa-solid fa-cloud"></i>', color: 'text-gray-400' };
    }

    // --- Itinerary & Render Helpers ---
    function renderHeaderInfo() {
        const container = document.getElementById('header-cards');
        container.innerHTML = `
        <div class="bg-white rounded-2xl p-4 mb-3 shadow-sm border border-gray-100 flex items-center justify-between">
             <div class="flex items-center gap-3">
                 <div class="w-10 h-10 rounded-full bg-nook-green flex items-center justify-center text-white font-bold"><i class="fa-solid fa-user-tie"></i></div>
                 <div>
                     <div class="text-xs text-gray-400">å°éŠ Guide</div>
                     <div class="font-bold text-gray-700">æ—ä¸–è±ª (Lin)</div>
                 </div>
             </div>
             <div class="text-right">
                 <a href="tel:0912576813" class="block text-sm font-bold text-blue-500"><i class="fa-solid fa-phone mr-1"></i>0912-576-813</a>
                 <a href="tel:07032853517" class="block text-xs text-gray-400 mt-1">JP: 070-3285-3517</a>
             </div>
        </div>

        <div class="bg-[#FFF0F0] rounded-2xl p-5 mb-4 shadow-sm border border-[#FFE0E0]">
            <div class="flex items-center gap-2 mb-2 text-[#D65A5A] font-bold text-lg"><i class="fa-solid fa-bell"></i> é›†åˆè³‡è¨Š</div>
            <div class="flex items-baseline gap-3 mb-1"><span class="text-3xl font-bold text-gray-800">06:30</span><span class="text-gray-600 font-bold">æ¡ƒæ©Ÿä¸€èˆªå»ˆ</span></div>
            <div class="flex justify-between items-end"><div class="text-sm text-gray-500">æ³°ç…èˆªç©º 2è™Ÿæ«ƒå°</div><a href="https://www.google.com/maps/search/?api=1&query=æ¡ƒåœ’æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ" target="_blank" class="bg-white text-[#D65A5A] px-4 py-1.5 rounded-lg text-sm shadow-sm border border-[#FADEDE] font-bold btn-press"><i class="fa-solid fa-location-dot mr-1"></i> å°èˆª</a></div>
        </div>
        
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-4">
            <h3 class="text-[#B59868] font-bold text-lg mb-6 flex items-center"><i class="fa-solid fa-plane mr-2 transform -rotate-45"></i> èˆªç­ (æ³°ç…)</h3>
            <div class="flex justify-between items-center mb-6">
                <div class="text-center w-1/4"><div class="text-3xl font-bold text-gray-800">TPE</div><div class="text-gray-400 text-sm">09:00</div></div>
                <div class="flex-1 px-2 text-center relative"><div class="text-xs text-gray-400 font-bold mb-1">SL398</div><div class="relative flex items-center justify-center py-2"><div class="h-[2px] bg-gray-200 w-full absolute border-b border-dashed border-gray-300"></div><i class="fa-solid fa-plane text-[#B59868] bg-white px-2 relative z-10 text-sm"></i></div><div class="text-xs text-gray-400">1/2 (äº”)</div></div>
                <div class="text-center w-1/4"><div class="text-3xl font-bold text-gray-800">NGO</div><div class="text-gray-400 text-sm">12:40</div></div>
            </div>
            <div class="border-b border-gray-100 my-4"></div>
            <div class="flex justify-between items-center">
                <div class="text-center w-1/4"><div class="text-3xl font-bold text-gray-800">NGO</div><div class="text-gray-400 text-sm">13:40</div></div>
                <div class="flex-1 px-2 text-center relative"><div class="text-xs text-gray-400 font-bold mb-1">SL399</div><div class="relative flex items-center justify-center py-2"><div class="h-[2px] bg-gray-200 w-full absolute border-b border-dashed border-gray-300"></div><i class="fa-solid fa-plane text-[#B59868] bg-white px-2 relative z-10 text-sm transform rotate-180"></i></div><div class="text-xs text-gray-400">1/7 (ä¸‰)</div></div>
                <div class="text-center w-1/4"><div class="text-3xl font-bold text-gray-800">TPE</div><div class="text-gray-400 text-sm">16:00</div></div>
            </div>
        </div>`;
    }
    
    function renderDayTabs() {
        const container = document.getElementById('day-tabs');
        if(!appData.days) return; 
        let html = '';
        appData.days.forEach((d, idx) => {
            const activeClass = idx === currentDayIndex ? 'bg-nook-green text-white shadow-md' : 'bg-white text-gray-500 border border-gray-200';
            // ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨ d.date é¡¯ç¤ºå®Œæ•´æ—¥æœŸ (å«æ˜ŸæœŸå¹¾)ï¼Œä¸å†ä½¿ç”¨ split åˆ‡å‰²
            html += `<button onclick="selectDay(${idx})" class="flex-shrink-0 px-4 py-2 rounded-xl transition-all ${activeClass}"><div class="text-xs font-bold">${d.day}</div><div class="text-[10px] opacity-80">${d.date}</div></button>`;
        });
        container.innerHTML = html;
    }
    
    function selectDay(idx) { 
        currentDayIndex = idx; 
        renderDayTabs(); 
        renderItinerary(); 
        // Also update note view if it's visible, or just update data
        renderNoteDayTabs();
        renderNotes();
    }

    // --- Itinerary Logic (Restored) ---
    function renderItinerary() {
        const container = document.getElementById('itinerary-container');
        if(!appData.days) return;
        const dayData = appData.days[currentDayIndex];
        let html = `<div class="text-center mb-4"><span class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full"><i class="fa-solid fa-map-pin mr-1"></i>${dayData.location}</span></div><div id="sortable-list" class="space-y-4 pb-20">`;
        
        if(!dayData.activities) dayData.activities = [];
        
        dayData.activities.forEach((act, idx) => {
            const mapUrl = act.link ? act.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(act.city ? act.city + ' ' + act.title : act.title)}`;
            const isHighlight = act.highlight ? 'border-l-4 border-nook-accent bg-orange-50' : '';
            
            // Image Logic
            let imgHtml = '';
            if (act.image) {
                 imgHtml = `<div class="mt-2 relative group"><img src="${act.image}" class="w-full h-32 object-cover rounded-lg shadow-sm"></div>`;
                 if(isEditMode) imgHtml = `<div class="mt-2 relative"><img src="${act.image}" class="w-full h-32 object-cover rounded-lg opacity-50"><button onclick="removeImage('${dayData.id}', ${idx})" class="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full"><i class="fa-solid fa-xmark"></i></button></div>`;
            } else if (isEditMode) {
                 imgHtml = `<div class="mt-2 border-2 border-dashed border-gray-300 rounded-lg p-2 text-center"><label class="cursor-pointer block"><i class="fa-solid fa-camera text-gray-400"></i><input type="file" accept="image/*" class="hidden" onchange="uploadImage(this, '${dayData.id}', ${idx})"></label></div>`;
            }

            if (isEditMode) {
                // Edit Template
                 html += `
                    <div class="bg-white rounded-xl p-3 border border-[#E0E5D5] shadow-sm relative pl-10" data-id="${idx}">
                        <div class="drag-handle absolute left-0 top-0 bottom-0 w-8 flex items-center justify-center cursor-move text-gray-300 bg-gray-50 rounded-l-xl border-r border-gray-100"><i class="fa-solid fa-grip-vertical"></i></div>
                        <button onclick="deleteActivity('${dayData.id}', ${idx})" class="absolute top-2 right-2 text-red-400 text-xs"><i class="fa-solid fa-trash"></i></button>
                        <div class="space-y-2">
                             <div class="flex gap-2"><input type="text" class="edit-input w-16 text-sm" value="${act.time}" onchange="updateActivity('${dayData.id}', ${idx}, 'time', this.value)"><input type="text" class="edit-input flex-1 font-bold" value="${act.title}" onchange="updateActivity('${dayData.id}', ${idx}, 'title', this.value)"></div>
                             <div class="flex gap-2"><input type="text" class="edit-input w-16 text-xs" value="${act.city||''}" onchange="updateActivity('${dayData.id}', ${idx}, 'city', this.value)" placeholder="åœ°é»"><input type="text" class="edit-input flex-1 text-xs" value="${act.desc||''}" onchange="updateActivity('${dayData.id}', ${idx}, 'desc', this.value)" placeholder="æè¿°"></div>
                             <div class="mt-2"><input type="text" class="edit-input text-xs text-blue-500 w-full" value="${act.link || ''}" onchange="updateActivity('${dayData.id}', ${idx}, 'link', this.value)" placeholder="ğŸ”— è‡ªè¨‚ Google Maps é€£çµ (é¸å¡«)"></div>
                        </div>
                        ${imgHtml}
                    </div>`;
            } else {
                // View Template
                html += `<div class="relative pl-4" data-id="${idx}"><div class="absolute left-0 top-2 bottom-2 w-0.5 bg-gray-200"></div><div class="absolute left-[-4px] top-3 w-2.5 h-2.5 rounded-full bg-nook-green border-2 border-white shadow-sm"></div><div class="bg-white rounded-xl p-3 border border-[#E0E5D5] shadow-sm ${isHighlight} ml-2"><div class="flex justify-between items-start"><div class="flex items-center gap-2"><span class="font-mono text-nook-green font-bold text-sm bg-[#F7F4EB] px-2 rounded">${act.time}</span>${act.city ? `<span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 rounded">${act.city}</span>` : ''}</div><a href="${mapUrl}" target="_blank" class="text-xs text-blue-500"><i class="fa-solid fa-location-dot"></i></a></div><h4 class="font-bold text-gray-800 mt-1 text-base">${act.title}</h4>${act.desc ? `<p class="text-sm text-gray-500 mt-1 leading-relaxed">${act.desc}</p>` : ''}${imgHtml}</div></div>`;
            }
        });
        html += `</div>`;
        container.innerHTML = html;
        if (isEditMode && Sortable) {
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = Sortable.create(document.getElementById('sortable-list'), { handle: '.drag-handle', animation: 150, onEnd: function (evt) { const day = appData.days[currentDayIndex]; const item = day.activities.splice(evt.oldIndex, 1)[0]; day.activities.splice(evt.newIndex, 0, item); saveData(); renderItinerary(); }});
        }
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        const btn = document.getElementById('edit-btn');
        const addBtn = document.getElementById('add-activity-btn');
        
        if (isEditMode) {
            btn.innerHTML = '<i class="fa-solid fa-check mr-1"></i>å®Œæˆ';
            btn.className = "bg-nook-green text-white px-4 py-1.5 rounded-full shadow-soft border border-nook-green font-bold active:scale-95 transition cursor-pointer text-xs flex items-center min-w-[70px] justify-center";
            addBtn.classList.remove('hidden');
        } else {
            btn.innerHTML = '<i class="fa-solid fa-pen mr-1"></i>ç·¨è¼¯';
            btn.className = "bg-white text-gray-600 px-4 py-1.5 rounded-full shadow-soft border border-[#E0E5D5] font-bold active:scale-95 transition cursor-pointer text-xs flex items-center min-w-[70px] justify-center";
            addBtn.classList.add('hidden');
        }
        renderItinerary();
    }

    // CRUD for Activities
    function updateActivity(dayId, idx, field, value) { const day = appData.days.find(d => d.id === dayId); if (day) { day.activities[idx][field] = value; saveData(); } }
    function addNewActivity() { const day = appData.days[currentDayIndex]; day.activities.push({ id: Date.now(), time: "00:00", title: "æ–°è¡Œç¨‹", type: "spot", desc: "", city: "" }); saveData(); renderItinerary(); }
    
    // ä¿®æ­£ï¼šä½¿ç”¨ showConfirm æ¨¡æ…‹æ¡†å–ä»£åŸç”Ÿçš„ confirm
    function deleteActivity(dayId, idx) { 
        showConfirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹é …ç›®ï¼Ÿ', () => { 
            const day = appData.days.find(d => d.id === dayId); 
            day.activities.splice(idx, 1); 
            saveData(); 
            renderItinerary(); 
        }); 
    }
    
    function uploadImage(input, dayId, idx) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.src = e.target.result; img.onload = function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const scale = 400 / img.width; canvas.width = 400; canvas.height = img.height * scale; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const day = appData.days.find(d => d.id === dayId); day.activities[idx].image = canvas.toDataURL('image/jpeg', 0.6); saveData(); renderItinerary(); } }; reader.readAsDataURL(input.files[0]); } }
    function removeImage(dayId, idx) { const day = appData.days.find(d => d.id === dayId); delete day.activities[idx].image; saveData(); renderItinerary(); }
    
    // UI Helpers
    function showImageModal(src) { document.getElementById('modal-img').src = src; document.getElementById('image-modal').classList.remove('hidden'); }
    function closeImageModal() { document.getElementById('image-modal').classList.add('hidden'); }
    function switchTab(tabId) { 
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); 
        document.getElementById(tabId).classList.add('active'); 
        window.scrollTo(0,0); 
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); 
        const map = {'view-plan':0, 'view-notes':1, 'view-wallet':2, 'view-lists':3, 'view-info':4}; 
        document.querySelectorAll('.nav-item')[map[tabId]].classList.add('active'); 
        
        if (tabId === 'view-info') fetchWeather();
    }

    // --- Custom Alert Modal Logic ---
    function showAlert(msg) {
        const modal = document.getElementById('alert-modal');
        const box = document.getElementById('alert-box');
        document.getElementById('alert-msg').innerText = msg;
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            box.classList.remove('scale-95');
            box.classList.add('scale-100');
        }, 10);
    }

    function closeAlert() {
        const modal = document.getElementById('alert-modal');
        const box = document.getElementById('alert-box');
        modal.classList.add('opacity-0');
        box.classList.remove('scale-100');
        box.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    // --- Custom Confirm Modal Logic ---
    function showConfirm(msg, callback) {
        const modal = document.getElementById('confirm-modal');
        const box = document.getElementById('confirm-box');
        document.getElementById('confirm-msg').innerText = msg;
        confirmCallback = callback;
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            box.classList.remove('scale-95');
            box.classList.add('scale-100');
        }, 10);
        
        // Setup Yes Button
        const yesBtn = document.getElementById('confirm-btn-yes');
        yesBtn.onclick = function() {
            if(confirmCallback) confirmCallback();
            closeConfirm();
        };
    }

    function closeConfirm() {
        const modal = document.getElementById('confirm-modal');
        const box = document.getElementById('confirm-box');
        modal.classList.add('opacity-0');
        box.classList.remove('scale-100');
        box.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
            confirmCallback = null;
        }, 300);
    }
</script>
</body>
</html>
