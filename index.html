<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>北陸名花之里之旅 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'nook-bg': '#F7F4EB',
                        'nook-green': '#88AB8E',
                        'nook-dark': '#6B5B45',
                        'nook-card': '#FFFFFF',
                        'nook-accent': '#E76F51',
                    },
                    boxShadow: {
                        'soft': '4px 4px 0px #E0E5D5',
                        'soft-hover': '2px 2px 0px #E0E5D5',
                    },
                    fontFamily: {
                        'rounded': ['"M PLUS Rounded 1c"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #F7F4EB;
            background-image: radial-gradient(#E0E5D5 2px, transparent 2px);
            background-size: 20px 20px;
            color: #6B5B45;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .btn-press:active { transform: scale(0.95); box-shadow: 2px 2px 0px #E0E5D5 !important; transform: translate(2px, 2px); }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }

        /* 拖曳時的樣式 */
        .sortable-ghost { opacity: 0.4; background: #f0f0f0; border: 2px dashed #ccc; }
        .sortable-drag { cursor: grabbing; opacity: 1; background: white; transform: rotate(2deg); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        /* 編輯模式輸入框 */
        .edit-input { width: 100%; border-bottom: 1px dashed #88AB8E; background: transparent; outline: none; padding: 2px 0; color: #6B5B45; }
        .edit-input:focus { border-bottom: 2px solid #88AB8E; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-item.active i { color: #88AB8E; transform: scale(1.1); }
        .nav-item.active span { color: #88AB8E; font-weight: bold; }
    </style>
</head>
<body class="pb-24">

    <header class="sticky top-0 z-40 bg-[#F7F4EB]/95 backdrop-blur-sm px-4 py-3 border-b border-[#E0E5D5] shadow-sm">
        <div class="flex justify-between items-center">
            <h1 class="text-lg font-bold text-nook-green tracking-wide truncate">
                <i class="fa-solid fa-plane-departure mr-2"></i>北陸名花之里
            </h1>
            <div class="flex items-center gap-2">
                <button onclick="toggleEditMode()" id="edit-btn" class="text-xs bg-white px-3 py-1.5 rounded-full shadow-soft border border-[#E0E5D5] text-gray-500 font-bold active:scale-95 transition">
                    <i class="fa-solid fa-pen mr-1"></i>編輯行程
                </button>
            </div>
        </div>
    </header>

    <main id="app" class="px-4 py-4 max-w-md mx-auto">
        
        <section id="view-plan" class="tab-content active">
            
            <div class="bg-white rounded-2xl p-4 mb-4 border border-[#E0E5D5] shadow-soft relative overflow-hidden">
                <div class="flex justify-between items-center mb-2 border-b-2 border-[#F7F4EB] pb-2">
                     <h2 class="text-base font-bold text-nook-green"><i class="fa-solid fa-address-card mr-2"></i>團體資訊</h2>
                     <div id="clock" class="text-xs font-mono text-gray-400">00:00</div>
                </div>
                <div class="space-y-1 text-sm">
                     <div class="flex items-start">
                        <span class="font-bold min-w-[40px] text-nook-dark">導遊:</span>
                        <span>林世豪 <a href="tel:0912576813" class="ml-2 text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full text-xs"><i class="fa-solid fa-phone"></i> 撥打</a></span>
                    </div>
                    <div class="flex items-start">
                        <span class="font-bold min-w-[40px] text-nook-dark">航班:</span>
                        <div id="flight-info" class="text-xs text-gray-600"></div>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t border-dashed border-gray-200">
                    <div id="hotel-info" class="space-y-1"></div>
                </div>
            </div>

            <div class="flex overflow-x-auto no-scrollbar gap-2 mb-4 pb-1" id="day-tabs">
                </div>

            <div id="itinerary-container" class="min-h-[300px]">
                </div>
            
            <div id="add-activity-btn" class="hidden mt-4 text-center">
                <button onclick="addNewActivity()" class="bg-nook-green text-white px-4 py-2 rounded-xl shadow-soft btn-press text-sm font-bold w-full">
                    <i class="fa-solid fa-plus mr-2"></i>新增行程項目
                </button>
            </div>
        </section>

        <section id="view-guide" class="tab-content">
             <div class="bg-white rounded-2xl p-5 border border-[#E0E5D5] shadow-soft mb-4">
                <h2 class="font-bold mb-3 text-nook-green">景點地圖快速查</h2>
                <div class="grid grid-cols-2 gap-3">
                    <a href="https://goo.gl/maps/search/白川鄉合掌村" target="_blank" class="bg-gray-50 p-3 rounded-xl text-center text-sm text-gray-700 hover:bg-gray-100"><i class="fa-solid fa-map-location-dot text-red-400 block mb-1 text-xl"></i>合掌村</a>
                    <a href="https://goo.gl/maps/search/兼六園" target="_blank" class="bg-gray-50 p-3 rounded-xl text-center text-sm text-gray-700 hover:bg-gray-100"><i class="fa-brands fa-envira text-green-600 block mb-1 text-xl"></i>兼六園</a>
                    <a href="https://goo.gl/maps/search/新穗高纜車" target="_blank" class="bg-gray-50 p-3 rounded-xl text-center text-sm text-gray-700 hover:bg-gray-100"><i class="fa-solid fa-cable-car text-blue-400 block mb-1 text-xl"></i>新穗高</a>
                    <a href="https://goo.gl/maps/search/名花之里" target="_blank" class="bg-gray-50 p-3 rounded-xl text-center text-sm text-gray-700 hover:bg-gray-100"><i class="fa-solid fa-lightbulb text-yellow-400 block mb-1 text-xl"></i>名花之里</a>
                </div>
            </div>
        </section>

        <section id="view-wallet" class="tab-content">
             <div class="bg-nook-green p-5 rounded-2xl shadow-soft text-white mb-6">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs opacity-80">日幣匯率</label>
                    <div class="flex items-center">
                        <span class="text-xs mr-1">x</span>
                        <input type="number" id="exchange-rate" value="0.22" step="0.001" class="w-16 text-right text-nook-dark rounded px-1 py-0.5 text-sm font-bold">
                    </div>
                </div>
                <div class="bg-white/20 rounded-xl p-3 mb-3">
                    <input type="text" id="calc-input" placeholder="500+200*3" class="w-full bg-transparent text-right text-white text-xl font-mono placeholder-white/50 outline-none">
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-3xl font-bold font-mono">≈ <span id="calc-result-twd">0</span></div>
                    <button onclick="calculate()" class="bg-white text-nook-green px-4 py-2 rounded-lg font-bold shadow-sm btn-press">計算</button>
                </div>
            </div>
            <div class="bg-white rounded-2xl p-4 border border-[#E0E5D5] shadow-soft">
                <div class="text-center text-gray-400 py-4">功能與前版相同，為節省長度略過顯示。</div>
            </div>
        </section>

        <section id="view-lists" class="tab-content">
             <div class="bg-white rounded-2xl p-5 border border-[#E0E5D5] shadow-soft mb-6">
                <h3 class="font-bold mb-3 text-nook-green"><i class="fa-solid fa-clipboard-check mr-2"></i>行前準備</h3>
                <div id="checklist-container" class="space-y-2"></div>
            </div>
        </section>

        <section id="view-info" class="tab-content">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-blue-50 p-4 rounded-2xl border border-blue-100 shadow-sm flex flex-col items-center justify-center text-center btn-press">
                    <i class="fa-solid fa-cloud-sun text-3xl text-blue-400 mb-2"></i>
                    <span class="font-bold text-gray-700">天氣預報</span>
                </a>
                <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="bg-purple-50 p-4 rounded-2xl border border-purple-100 shadow-sm flex flex-col items-center justify-center text-center btn-press">
                    <i class="fa-solid fa-qrcode text-3xl text-purple-500 mb-2"></i>
                    <span class="font-bold text-gray-700">Visit Japan</span>
                </a>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur border-t border-[#E0E5D5] pb-safe pt-2 px-2 z-50">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <button onclick="switchTab('view-plan')" class="nav-item active flex flex-col items-center p-2 w-16 transition-all duration-300">
                <i class="fa-solid fa-calendar-days text-xl text-gray-400 mb-1"></i><span class="text-[10px] text-gray-400">行程</span>
            </button>
            <button onclick="switchTab('view-guide')" class="nav-item flex flex-col items-center p-2 w-16 transition-all duration-300">
                <i class="fa-solid fa-book-open text-xl text-gray-400 mb-1"></i><span class="text-[10px] text-gray-400">導覽</span>
            </button>
            <button onclick="switchTab('view-wallet')" class="nav-item flex flex-col items-center p-2 w-16 transition-all duration-300">
                <div class="bg-nook-green rounded-full w-12 h-12 flex items-center justify-center -mt-6 border-4 border-[#F7F4EB] shadow-md">
                    <i class="fa-solid fa-wallet text-xl text-white"></i>
                </div>
            </button>
            <button onclick="switchTab('view-lists')" class="nav-item flex flex-col items-center p-2 w-16 transition-all duration-300">
                <i class="fa-solid fa-list-check text-xl text-gray-400 mb-1"></i><span class="text-[10px] text-gray-400">清單</span>
            </button>
            <button onclick="switchTab('view-info')" class="nav-item flex flex-col items-center p-2 w-16 transition-all duration-300">
                <i class="fa-solid fa-circle-info text-xl text-gray-400 mb-1"></i><span class="text-[10px] text-gray-400">資訊</span>
            </button>
        </div>
        <div class="h-4 w-full"></div> 
    </nav>

    <script>
        // ==========================================
        // --- 資料核心 ---
        // ==========================================
        
        [cite_start]// 預設資料 (若 LocalStorage 無資料時使用) [cite: 1, 2, 3, 14, 19-61]
        const DEFAULT_DATA = {
            flight: "去程: 泰獅 SL398 09:00 -> 12:40 | 回程: SL399 13:40 -> 16:00",
            // 飯店加上搜尋關鍵字，以便生成地圖連結
            hotels: [
                { day: "D1", name: "名古屋希爾頓酒店", query: "Hilton Nagoya" },
                { day: "D2", name: "御岳 Golf & Resort", query: "Ontake Golf and Resort Hotel" },
                { day: "D3", name: "Route INN Grantia 飛驒高山", query: "Route Inn Grantia Hida Takayama" },
                { day: "D4", name: "金澤 T-MARK HOTEL", query: "T-Mark City Hotel Kanazawa" },
                { day: "D5", name: "名古屋 Centmain 飯店", query: "Nagoya Centmain Hotel" } // 若找不到會搜到近似結果
            ],
            checklist: ["護照", "網卡", "行動電源(隨身)", "日幣", "常備藥", "牙刷牙膏"],
            // 每日行程 (加入 city 標籤)
            days: [
                {
                    id: "d1", day: "D1", date: "01/02 (五)", location: "愛知縣",
                    activities: [
                        { id: "a1-1", time: "06:30", title: "桃機一航廈泰獅櫃台集合", type: "transport", city: "桃園", desc: "找導遊: 林世豪" },
                        { id: "a1-2", time: "12:40", title: "抵達中部國際機場", type: "transport", city: "常滑", desc: "出關領行李" },
                        { id: "a1-3", time: "15:00", title: "飯店 Check-in", type: "stay", city: "名古屋", desc: "放置行李，休息" }
                    ]
                },
                {
                    id: "d2", day: "D2", date: "01/03 (六)", location: "岐阜縣",
                    activities: [
                        { id: "a2-1", time: "09:00", title: "惠那峽展望台", type: "spot", city: "惠那", desc: "斷崖絕壁與奇岩怪石" },
                        { id: "a2-2", time: "12:00", title: "馬籠宿 / 妻籠宿", type: "spot", city: "中津川", desc: "江戶時代古驛站散策" },
                        { id: "a2-3", time: "17:00", title: "溫泉鄉住宿", type: "stay", city: "御岳", desc: "享用溫泉會席料理" }
                    ]
                },
                {
                    id: "d3", day: "D3", date: "01/04 (日)", location: "岐阜縣",
                    activities: [
                        { id: "a3-1", time: "09:30", title: "新穗高雙層纜車", type: "spot", city: "高山", highlight: true, desc: "眺望阿爾卑斯山雪景" },
                        { id: "a3-2", time: "13:30", title: "飛驒高山 (上三之町)", type: "spot", city: "高山", desc: "米其林三星古街，吃飛驒牛握壽司" },
                        { id: "a3-3", time: "18:00", title: "入住飛驒高山溫泉", type: "stay", city: "高山", desc: "享受溫泉" }
                    ]
                },
                {
                    id: "d4", day: "D4", date: "01/05 (一)", location: "北陸",
                    activities: [
                        { id: "a4-1", time: "09:00", title: "庄川峽遊船", type: "spot", city: "富山", desc: "雪見遊船，欣賞溪谷風情" },
                        { id: "a4-2", time: "12:00", title: "近江町市場", type: "food", city: "金澤", desc: "金澤的廚房，午餐自理" },
                        { id: "a4-3", time: "14:00", title: "兼六園 & 傘松雪吊", type: "spot", city: "金澤", highlight: true, desc: "日本三大名園之一" },
                        { id: "a4-4", time: "16:00", title: "東茶屋街", type: "spot", city: "金澤", desc: "感受江戶時代風情" }
                    ]
                },
                {
                    id: "d5", day: "D5", date: "01/06 (二)", location: "岐阜/三重",
                    activities: [
                        { id: "a5-1", time: "09:30", title: "白川鄉合掌村", type: "spot", city: "白川鄉", highlight: true, desc: "世界文化遺產，童話雪景" },
                        { id: "a5-2", time: "14:00", title: "三井 OUTLET 長島", type: "shopping", city: "桑名", desc: "爵士之夢長島，瘋狂血拼" },
                        { id: "a5-3", time: "17:30", title: "名花之里夢幻點燈", type: "spot", city: "桑名", highlight: true, desc: "日本最大規模燈海" }
                    ]
                },
                {
                    id: "d6", day: "D6", date: "01/07 (三)", location: "愛知縣",
                    activities: [
                        { id: "a6-1", time: "09:00", title: "自由活動", type: "spot", city: "名古屋", desc: "最後補貨或休息" },
                        { id: "a6-2", time: "11:30", title: "前往中部國際機場", type: "transport", city: "常滑", desc: "辦理登機 SL399" },
                        { id: "a6-3", time: "16:00", title: "抵達桃園機場", type: "transport", city: "桃園", desc: "溫暖的家" }
                    ]
                }
            ]
        };

        // 全域變數
        let appData = {};
        let currentDayIndex = 0;
        let isEditMode = false;
        let sortableInstance = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderHeaderInfo();
            renderDayTabs();
            renderItinerary();
            loadChecklist();
            updateClock();
            setInterval(updateClock, 1000);
        });

        // 讀取資料 (Localstorage 或 Default)
        function loadData() {
            const saved = localStorage.getItem('travelApp_data_v2');
            if (saved) {
                appData = JSON.parse(saved);
            } else {
                appData = JSON.parse(JSON.stringify(DEFAULT_DATA)); // Deep copy
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('travelApp_data_v2', JSON.stringify(appData));
        }

        [cite_start]// 渲染: 團體資訊與飯店連結 [cite: 1, 14]
        function renderHeaderInfo() {
            document.getElementById('flight-info').innerText = appData.flight;
            
            const hotelHtml = appData.hotels.map(h => {
                // 生成 Google Maps 連結
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.query)}`;
                return `
                    <div class="flex justify-between items-center text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded">
                        <span><span class="font-bold text-nook-green mr-1">${h.day}</span> ${h.name}</span>
                        <a href="${mapLink}" target="_blank" class="text-blue-500 hover:text-blue-700">
                            <i class="fa-solid fa-location-arrow"></i>
                        </a>
                    </div>
                `;
            }).join('');
            document.getElementById('hotel-info').innerHTML = hotelHtml;
        }

        [cite_start]// 渲染: D1-D6 分頁 Tab [cite: 12]
        function renderDayTabs() {
            const container = document.getElementById('day-tabs');
            let html = '';
            appData.days.forEach((d, idx) => {
                const activeClass = idx === currentDayIndex ? 
                    'bg-nook-green text-white shadow-md' : 'bg-white text-gray-500 border border-gray-200';
                
                html += `
                    <button onclick="selectDay(${idx})" class="flex-shrink-0 px-4 py-2 rounded-xl transition-all ${activeClass}">
                        <div class="text-xs font-bold">${d.day}</div>
                        <div class="text-[10px] opacity-80">${d.date.split(' ')[0]}</div>
                    </button>
                `;
            });
            container.innerHTML = html;
        }

        function selectDay(idx) {
            currentDayIndex = idx;
            renderDayTabs();
            renderItinerary();
        }

        // 渲染: 行程列表 (支援顯示/編輯模式)
        function renderItinerary() {
            const container = document.getElementById('itinerary-container');
            const dayData = appData.days[currentDayIndex];
            
            let html = `
                <div class="text-center mb-4">
                    <span class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full">
                        <i class="fa-solid fa-map-pin mr-1"></i>${dayData.location}
                    </span>
                </div>
                <div id="sortable-list" class="space-y-4 pb-20">
            `;

            dayData.activities.forEach((act, idx) => {
                // 地圖連結: 如果沒有 city，就用 title 搜
                const query = act.city ? `${act.city} ${act.title}` : act.title;
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                const isHighlight = act.highlight ? 'border-l-4 border-nook-accent bg-orange-50' : '';
                
                // 圖片顯示
                let imgHtml = '';
                if (act.image) {
                    imgHtml = `
                        <div class="mt-2 relative group">
                            <img src="${act.image}" class="w-full h-32 object-cover rounded-lg shadow-sm">
                            ${isEditMode ? `<button onclick="removeImage('${dayData.id}', ${idx})" class="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full text-xs shadow-md"><i class="fa-solid fa-xmark"></i></button>` : ''}
                        </div>`;
                } else if (isEditMode) {
                    imgHtml = `
                        <div class="mt-2 border-2 border-dashed border-gray-300 rounded-lg p-2 text-center">
                            <label class="cursor-pointer block">
                                <i class="fa-solid fa-camera text-gray-400"></i>
                                <span class="text-xs text-gray-400 block">上傳照片</span>
                                <input type="file" accept="image/*" class="hidden" onchange="uploadImage(this, '${dayData.id}', ${idx})">
                            </label>
                        </div>`;
                }

                if (isEditMode) {
                    // --- 編輯模式 ---
                    html += `
                        <div class="bg-white rounded-xl p-3 border border-[#E0E5D5] shadow-sm relative pl-10" data-id="${idx}">
                            <div class="drag-handle absolute left-0 top-0 bottom-0 w-8 flex items-center justify-center cursor-move text-gray-300 hover:text-gray-500 bg-gray-50 rounded-l-xl border-r border-gray-100">
                                <i class="fa-solid fa-grip-vertical"></i>
                            </div>
                            <button onclick="deleteActivity('${dayData.id}', ${idx})" class="absolute top-2 right-2 text-red-400 text-xs"><i class="fa-solid fa-trash"></i></button>
                            
                            <div class="space-y-2">
                                <div class="flex gap-2">
                                    <input type="text" class="edit-input w-20 font-mono text-sm" value="${act.time}" onchange="updateActivity('${dayData.id}', ${idx}, 'time', this.value)" placeholder="時間">
                                    <input type="text" class="edit-input flex-1 font-bold text-gray-800" value="${act.title}" onchange="updateActivity('${dayData.id}', ${idx}, 'title', this.value)" placeholder="標題">
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" class="edit-input w-20 text-xs" value="${act.city || ''}" onchange="updateActivity('${dayData.id}', ${idx}, 'city', this.value)" placeholder="地區">
                                    <input type="text" class="edit-input flex-1 text-xs text-gray-500" value="${act.desc || ''}" onchange="updateActivity('${dayData.id}', ${idx}, 'desc', this.value)" placeholder="備註/描述">
                                </div>
                            </div>
                            ${imgHtml}
                        </div>
                    `;
                } else {
                    // --- 檢視模式 ---
                    html += `
                        <div class="relative pl-4" data-id="${idx}">
                            <div class="absolute left-0 top-2 bottom-2 w-0.5 bg-gray-200"></div>
                            <div class="absolute left-[-4px] top-3 w-2.5 h-2.5 rounded-full bg-nook-green border-2 border-white shadow-sm"></div>
                            
                            <div class="bg-white rounded-xl p-3 border border-[#E0E5D5] shadow-sm ${isHighlight} ml-2">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono text-nook-green font-bold text-sm bg-[#F7F4EB] px-2 rounded">${act.time}</span>
                                        ${act.city ? `<span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 rounded">${act.city}</span>` : ''}
                                    </div>
                                    <a href="${mapUrl}" target="_blank" class="text-xs text-blue-500 hover:text-blue-700 flex items-center">
                                        <i class="fa-solid fa-location-dot mr-1"></i>地圖
                                    </a>
                                </div>
                                <h4 class="font-bold text-gray-800 mt-1 text-base">${getIconByType(act.type)} ${act.title}</h4>
                                ${act.desc ? `<p class="text-sm text-gray-500 mt-1 leading-relaxed">${act.desc}</p>` : ''}
                                ${imgHtml}
                            </div>
                        </div>
                    `;
                }
            });
            html += `</div>`;
            container.innerHTML = html;

            // 重新綁定拖曳功能
            if (isEditMode) initSortable();
        }

        // 圖示 helper
        function getIconByType(type) {
            const icons = { transport: 'train-subway', stay: 'bed', spot: 'camera', shopping: 'bag-shopping', food: 'utensils' };
            return `<i class="fa-solid fa-${icons[type] || 'circle-dot'} text-gray-400 mr-1 text-sm"></i>`;
        }

        // 切換編輯模式
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-btn');
            const addBtn = document.getElementById('add-activity-btn');
            
            if (isEditMode) {
                btn.innerHTML = '<i class="fa-solid fa-check mr-1"></i>完成';
                btn.classList.add('bg-nook-green', 'text-white');
                btn.classList.remove('bg-white', 'text-gray-500');
                addBtn.classList.remove('hidden');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-pen mr-1"></i>編輯行程';
                btn.classList.remove('bg-nook-green', 'text-white');
                btn.classList.add('bg-white', 'text-gray-500');
                addBtn.classList.add('hidden');
            }
            renderItinerary();
        }

        // --- 資料編輯功能 ---

        // 1. 更新文字內容
        function updateActivity(dayId, idx, field, value) {
            const day = appData.days.find(d => d.id === dayId);
            if (day) {
                day.activities[idx][field] = value;
                saveData();
            }
        }

        // 2. 新增行程
        function addNewActivity() {
            const day = appData.days[currentDayIndex];
            day.activities.push({
                id: Date.now(),
                time: "00:00",
                title: "新行程",
                type: "spot",
                desc: "",
                city: ""
            });
            saveData();
            renderItinerary();
        }

        // 3. 刪除行程
        function deleteActivity(dayId, idx) {
            if(confirm('確定刪除此行程嗎？')) {
                const day = appData.days.find(d => d.id === dayId);
                day.activities.splice(idx, 1);
                saveData();
                renderItinerary();
            }
        }

        // 4. 圖片上傳 (壓縮並存為 Base64)
        function uploadImage(input, dayId, idx) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // 壓縮至寬度 400px (手機瀏覽足夠，節省 localStorage)
                        const maxWidth = 400;
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const base64 = canvas.toDataURL('image/jpeg', 0.6);
                        
                        const day = appData.days.find(d => d.id === dayId);
                        day.activities[idx].image = base64;
                        saveData();
                        renderItinerary();
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        function removeImage(dayId, idx) {
            const day = appData.days.find(d => d.id === dayId);
            delete day.activities[idx].image;
            saveData();
            renderItinerary();
        }

        // 5. 拖曳排序 (SortableJS)
        function initSortable() {
            const el = document.getElementById('sortable-list');
            if (sortableInstance) sortableInstance.destroy();
            
            sortableInstance = Sortable.create(el, {
                handle: '.drag-handle', // 只能拉把手
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function (evt) {
                    // 更新數據順序
                    const day = appData.days[currentDayIndex];
                    const item = day.activities.splice(evt.oldIndex, 1)[0];
                    day.activities.splice(evt.newIndex, 0, item);
                    saveData();
                    // 重新渲染以修正 DOM index 與 data index 的對應
                    renderItinerary();
                }
            });
        }

        // 其他基礎功能 (Checklist, Clock, Wallet)
        function loadChecklist() {
            const list = appData.checklist;
            const savedState = JSON.parse(localStorage.getItem('travelApp_check_state') || '{}');
            let html = '';
            list.forEach((item, i) => {
                const checked = savedState[i] ? 'checked' : '';
                const style = savedState[i] ? 'line-through text-gray-400' : 'text-gray-700';
                html += `<label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" onchange="toggleCheck(${i}, this)" ${checked} class="w-5 h-5 text-nook-green rounded border-gray-300">
                    <span id="chk-${i}" class="${style}">${item}</span>
                </label>`;
            });
            document.getElementById('checklist-container').innerHTML = html;
        }

        function toggleCheck(idx, cb) {
            const savedState = JSON.parse(localStorage.getItem('travelApp_check_state') || '{}');
            savedState[idx] = cb.checked;
            localStorage.setItem('travelApp_check_state', JSON.stringify(savedState));
            const el = document.getElementById(`chk-${idx}`);
            el.className = cb.checked ? 'line-through text-gray-400' : 'text-gray-700';
        }

        function calculate() {
            const val = document.getElementById('calc-input').value;
            const rate = document.getElementById('exchange-rate').value;
            try {
                const res = Math.round(eval(val) * rate);
                document.getElementById('calc-result-twd').innerText = res;
            } catch(e) { alert('算式錯誤'); }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            window.scrollTo(0,0);
            
            // 更新底部按鈕樣式
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const map = {'view-plan':0, 'view-guide':1, 'view-wallet':2, 'view-lists':3, 'view-info':4};
            document.querySelectorAll('.nav-item')[map[tabId]].classList.add('active');
        }

        function updateClock() {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:false});
        }
    </script>
</body>
</html>
